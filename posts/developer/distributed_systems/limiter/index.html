<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>åˆ†å¸ƒå¼é™æµ | HyperTars' Blog</title><meta name=keywords content="Distributed System,Distributed Rate Limiter,Redis"><meta name=description content="Introduction to distributed rate limiter"><meta name=author content="HyperTars"><link rel=canonical href=https://blog.hypertars.com/posts/developer/distributed_systems/limiter/><link crossorigin=anonymous href=/assets/css/stylesheet.min.f34b707e96a5011787260c43994ea6cd89c86f5fef677a5e3c78f655715fd662.css integrity="sha256-80twfpalAReHJgxDmU6mzYnIb1/vZ3pePHj2VXFf1mI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.hypertars.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.hypertars.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.hypertars.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.hypertars.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.hypertars.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="åˆ†å¸ƒå¼é™æµ"><meta property="og:description" content="Introduction to distributed rate limiter"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hypertars.com/posts/developer/distributed_systems/limiter/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-04T00:00:00+08:00"><meta property="article:modified_time" content="2021-05-04T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="åˆ†å¸ƒå¼é™æµ"><meta name=twitter:description content="Introduction to distributed rate limiter"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Articles","item":"https://blog.hypertars.com/posts/"},{"@type":"ListItem","position":3,"name":"Developer","item":"https://blog.hypertars.com/posts/developer/"},{"@type":"ListItem","position":4,"name":"Distributed System","item":"https://blog.hypertars.com/posts/developer/distributed_systems/"},{"@type":"ListItem","position":5,"name":"åˆ†å¸ƒå¼é™æµ","item":"https://blog.hypertars.com/posts/developer/distributed_systems/limiter/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"åˆ†å¸ƒå¼é™æµ","name":"åˆ†å¸ƒå¼é™æµ","description":"Introduction to distributed rate limiter","keywords":["Distributed System","Distributed Rate Limiter","Redis"],"articleBody":"é™æµæ˜¯ä»€ä¹ˆ é«˜å¹¶å‘ç³»ç»Ÿåœ¨è¯·æ±‚è¿‡å¤šçš„æ—¶å€™ä¸»åŠ¨æ‹’ç»æœåŠ¡ã€‚\né™æµï¼šä¸»åŠ¨å¯¹è¶…è¿‡ä¸€å®šçš„è¯·æ±‚æµé‡è¿›è¡Œæ‹’ç»/ä¸¢å¼ƒ\né™çº§ï¼šå¯¹æ‰€æœ‰æµé‡è¿›è¡Œæ‹’ç»\nè¿‡è½½ä¿æŠ¤ï¼šæ£€æµ‹åˆ°æœ¬èº«æœåŠ¡ï¼ˆcpuã€é”™è¯¯ç‡ï¼‰åˆ°è¾¾ä¸€å®šç¨‹åº¦ï¼Œåˆ¤æ–­å½“å‰æµé‡è¿‡å¤§ï¼Œè¢«åŠ¨ä¿æŠ¤æœåŠ¡\nç†”æ–­ï¼šä¸ºäº†ä¿æŠ¤æœåŠ¡å™¨è‡ªå‘å‡å°‘æˆ–ä¸­æ–­è¯·æ±‚å‘æ”¾è¡Œä¸ºï¼ˆç†”æ–­ egressï¼Œè¿‡è½½ä¿æŠ¤ ingressï¼‰\nCollaborative Admission Controlï¼šç»Ÿç­¹è¿‡è½½ä¿æŠ¤å’Œç†”æ–­\nçŸ¥è¯†æ ‘ é™æµ å¯¹è±¡ åŸºäºè¯·æ±‚é™æµï¼ˆQPSï¼‰ åŸºäºèµ„æºé™æµï¼ˆåº“å­˜ã€é‡‘é¢ï¼‰ ä½ç½® æ¥å…¥å±‚é™æµï¼ˆnginxã€service meshï¼‰ åº”ç”¨å±‚é™æµ å­˜å‚¨å±‚é™æµï¼ˆMySQLã€MongoDBï¼‰ ç­–ç•¥ åŸºäºç‰¹å¾ï¼ˆIPã€IDï¼‰ åŸºäºæ¥å£é™æµ ç²’åº¦ å•æœºé™æµ é›†ç¾¤é™æµ ç®—æ³• é˜Ÿåˆ—ï¼ˆé˜»å¡é˜Ÿåˆ—ã€æœ‰é™é˜Ÿåˆ—ã€ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼‰ è®¡æ•°ï¼ˆå›ºå®šçª—å£ã€æ»‘åŠ¨çª—å£ï¼‰ æ¼æ¡¶ ä»¤ç‰Œæ¡¶ï¼ˆå•é€ŸåŒæ¡¶ã€åŒé€ŸåŒæ¡¶ã€ä¸‰è‰²åŒæ¼æ¡¶ï¼‰ å¸¸è§é™æµæ–¹å¼ è®¡æ•°å™¨é™æµ (Count-based Rate Limiter) åˆ†æ®µè®¡æ•°ï¼Œå›ºå®šæ—¶é—´çª—å£ åŸºæœ¬å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 type CountLimiter struct { counter int64 limit int64 intervalNano int64 unixNano int64 } func NewCountLimiter(interval time.Duration, limit int64) *CountLimiter { return \u0026CountLimiter{ counter: 0, limit: limit, intervalNano: int64(interval), unixNano: time.Now().UnixNano(), } } func (c *CountLimiter) Allow() bool { now := time.Now().UnixNano() if now-c.unixNano \u003e c.intervalNano { atomic.StoreInt64(\u0026c.counter, 0) atomic.StoreInt64(\u0026c.unixNano, now) return true } atomic.AddInt64(\u0026c.counter, 1) return c.counter \u003c= c.limit } é—®é¢˜ ç¬æ—¶æµé‡æ‹¥å¡\nçªå‘æµé‡å¯¼è‡´æ¯›åˆºç°è±¡ï¼Œé™æµä¸å‡†ç¡®\næ»‘åŠ¨çª—å£è®¡æ•°å™¨ (Sliding Window Rate Limiter) é€šè¿‡æ›´ç»†ç²’åº¦çš„æ»‘åŠ¨çª—å£è®¡æ•°å™¨è§£å†³ç¬æ—¶æµé‡é—®é¢˜ åŸºæœ¬å®ç° è®¾ç½®æˆæ›´å°çš„çª—å£ï¼Œæ›´ç»†ç²’åº¦é™åˆ¶æµé‡ï¼Œä½¿é™æµå˜å¾—å¹³æ»‘ å¦‚å›¾ï¼Œæ¯ 60 ç§’è¯·æ±‚ 100 æ¬¡ï¼Œä¸€ä¸ªå¤§çª—å£åˆ†æˆ 6 ä¸ªå°çª—å£ï¼Œæ¯ä¸ªå°çª—å£å¯å®¹çº³ 10 æ¬¡è¯·æ±‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 var once sync.Once type slidingWindowLimiter struct { curRequests int32 // å½“å‰è¯·æ±‚å€¼ durationRequests chan int32 // è¯·æ±‚é˜Ÿåˆ— accuracy time.Duration // æ—¶é—´çª—å£æœ€å°å•å…ƒ snippet time.Duration // æ—¶é—´çª—å£æ—¶é—´è·¨åº¦ curRequestsSum int32 // å½“å‰è¯·æ±‚æ•°ä¹‹å’Œ allowRequests int32 // æœ€å¤§å…è®¸æ•°é‡ } func NewSlidingWindowLimiter(accuracy, snippet time.Duration, allowRequests int32) *slidingWindowLimiter { return \u0026slidingWindowLimiter{ durationRequests: make(chan int32, snippet/accuracy), accuracy: accuracy, snippet: snippet, allowRequests: allowRequests, } } func (s *slidingWindowLimiter) Take() error { once.Do(func() { // å¾€å‰åˆ’åŠ¨ä¸€ä¸ªæœ€å°æ—¶é—´çª—å£ go sliding(s) go calculate(s) }) curRequest := atomic.LoadInt32(\u0026s.curRequestsSum) if curRequest \u003e= s.allowRequests { return ratelimit_kit.ErrExceededLimit } if !atomic.CompareAndSwapInt32(\u0026s.curRequestsSum, curRequest, curRequest+1) { //cas return ratelimit_kit.ErrExceededLimit } atomic.AddInt32(\u0026s.curRequests, 1) return nil } func sliding(s *slidingWindowLimiter) { for { select { case \u003c-time.After(s.accuracy): s.durationRequests \u003c- atomic.SwapInt32(\u0026s.curRequests, 0) } } } func calculate(s *slidingWindowLimiter) { for { \u003c-time.After(s.accuracy) if len(s.durationRequests) == cap(s.durationRequests) { // channelæ»¡äº† break } } for { \u003c-time.After(s.accuracy) t := \u003c-s.durationRequests if t != 0 { atomic.AddInt32(\u0026s.curRequestsSum, -t) } } } æ»‘åŠ¨çª—å£è®¡æ•°å™¨é™æµå®Œæ•´å®ç° 1\næ»‘åŠ¨çª—å£è®¡æ•°å™¨é™æµå®Œæ•´å®ç° 2\né—®é¢˜ æ—¶é—´åŒºé—´çš„ç²¾åº¦è¶Šé«˜ï¼Œç®—æ³•æ‰€éœ€çš„ç©ºé—´å®¹é‡å°±è¶Šå¤§ã€‚\nå®ç°ç¨å¾®å¤æ‚ä½†æ˜¯ä¾ç„¶ä¸èƒ½è§£å†³è®¡æ•°å™¨è¾¹ç•Œé—®é¢˜\nä»¤ç‰Œæ¡¶ (Token Bucket Rate Limiter) é™åˆ¶è¾“å…¥é€Ÿç‡\nä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯ç½‘ç»œæµé‡æ•´å½¢ Traffic Shaping å’Œé€Ÿç‡é™åˆ¶ Rate Limiting ä¸­æœ€å¸¸ä½¿ç”¨çš„ä¸€ç§ç®—æ³•\nä»¤ç‰Œæ¡¶åŸºæœ¬å¤„ç†æµç¨‹\näº§ç”Ÿä»¤ç‰Œï¼šå‘¨æœŸæ€§åœ°ä»¥ä¸€å®šé€Ÿç‡ï¼ˆå¦‚ 100msï¼‰å¾€ä»¤ç‰Œæ¡¶ä¸­å¢åŠ ä»¤ç‰Œï¼›å¦‚æœä»¤ç‰Œæ»¡äº†ï¼Œä¸¢å¼ƒå¤šä½™ä»¤ç‰Œ æ”¹è¿›ç®—æ³•å®æ—¶æ·»åŠ ä»¤ç‰Œæ•° æ¶ˆè€—ä»¤ç‰Œï¼šè¯·æ±‚æ¥æ—¶ï¼Œä»æ¡¶ä¸­å–ä»¤ç‰Œï¼›å¦‚æœå–åˆ°æ‰€éœ€æ•°é‡ä»¤ç‰Œï¼Œåˆ™é€šè¿‡ï¼›å¦‚æœå–ä¸åˆ°ï¼Œåˆ™é™æµ æ˜¯å¦é€šè¿‡ï¼šæ¡¶ä¸­çš„ä»¤ç‰Œ \u003e= æ‰€éœ€ä»¤ç‰Œï¼Œå¦åˆ™ï¼šç›´æ¥ä¸¢å¼ƒ / è¿›é˜Ÿåˆ—ç­‰å¾… / å¯ä»¥é€šè¿‡ä½†éœ€è¦ç‰¹æ®Šæ ‡è®° åŸºæœ¬å®ç° å®é™…å®ç°é‡‡ç”¨æ¯æ¬¡å–ä»¤ç‰Œçš„æ—¶å€™ç»Ÿè®¡ä¸ä¸Šæ¬¡è¯·æ±‚çš„ tickï¼Œæ¯æ¬¡å®æ—¶æ›´æ–°ï¼ˆè€Œéå‘¨æœŸæ€§å¾€æ¡¶ä¸­å¢åŠ ä»¤ç‰Œï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 // æ¯fillIntervalæ—¶é—´é—´éš”å¡«å……1ä¸ªtoken func NewBucket(fillInterval time.Duration, capacity int64) *Bucket { return NewBucketWithClock(fillInterval, capacity, nil) } return \u0026Bucket{ clock: clock, // for mock startTime: clock.Now(), // å¯åŠ¨æ—¶é—´ latestTick: 0, //æœ€åçš„tick fillInterval: fillInterval, // æ¯éš”å¤šä¹… capacity: capacity, // æœ€å¤§çš„å®¹é‡ quantum: quantum, // æ”¾å…¥quantumä¸ªtoken availableTokens: capacity, // å½“å‰å¯ç”¨tokenï¼ˆåˆå§‹åŒ–ä¸ºå®¹é‡ } // take token func (tb *Bucket) take(now time.Time, count int64, maxWait time.Duration) (time.Duration, bool) { if count \u003c= 0 { return 0, true } tick := tb.currentTick(now) tb.adjustavailableTokens(tick) avail := tb.availableTokens - count if avail \u003e= 0 { tb.availableTokens = avail return 0, true } // Round up the missing tokens to the nearest multiple // of quantum - the tokens won't be available until // that tick. // endTick holds the tick when all the requested tokens will // become available. endTick := tick + (-avail+tb.quantum-1)/tb.quantum endTime := tb.startTime.Add(time.Duration(endTick) * tb.fillInterval) waitTime := endTime.Sub(now) if waitTime \u003e maxWait { return 0, false } tb.availableTokens = avail return waitTime, true } // è®¡ç®—ä»ä»¤ç‰Œæ¡¶å¼€å§‹ç»è¿‡äº†å¤šå°‘ä¸ªtick ï¼ˆæ¯éš”tickä¼šå¡«å……quantumçš„token func (tb *Bucket) currentTick(now time.Time) int64 { return int64(now.Sub(tb.startTime) / tb.fillInterval) } // è®¡ç®—ä»ä¸Šä¸€æ¬¡tickåˆ°ç°åœ¨ç»è¿‡äº†å¤šå°‘ä¸ªtickï¼Œtick*quantum+availableç­‰äºç›®å‰å¯ä»¥ä½¿ç”¨çš„tokenæ•°é‡ func (tb *Bucket) adjustavailableTokens(tick int64) { lastTick := tb.latestTick tb.latestTick = tick if tb.availableTokens \u003e= tb.capacity { return } tb.availableTokens += (tick - lastTick) * tb.quantum if tb.availableTokens \u003e tb.capacity { tb.availableTokens = tb.capacity } return } æ¯æ¬¡éƒ½ä¼šæ›´æ–°å½“å‰å¯ç”¨çš„æ•°é‡ï¼ˆè¯»è§¦å‘ï¼‰ï¼Œå†å‡å»éœ€æ±‚é‡ ä»¤ç‰Œæ¡¶å®Œæ•´å®ç° 1\nä»¤ç‰Œæ¡¶å®Œæ•´å®ç° 2\né—®é¢˜ çªåˆºé—®é¢˜\nåœ¨æœåŠ¡å™¨èµ„æºç©ºé—²çš„çŠ¶æ€ä¸‹ä¼šé€ æˆæå¤§çš„æµªè´¹\næ¼æ–—æ¡¶ (Leaky Bucket Rate Limiter) é™åˆ¶è¾“å‡ºé€Ÿç‡\nè¯·æ±‚ç±»ä¼¼æ°´æµï¼Œå…ˆè¿›å…¥æ¼æ¡¶ä¸­ï¼Œæ¼æ¡¶ä»¥ä¸€å®šçš„é€Ÿç‡å‡ºæ°´ï¼ˆæ¥å£å“åº”é€Ÿç‡ï¼‰ï¼Œå½“æ°´æµé€Ÿç‡è¿‡å¤§ä¼šç›´æ¥æº¢å‡ºï¼ˆè®¿é—®é¢‘ç‡è¶…è¿‡æ¥å£å“åº”é€Ÿç‡ï¼‰ï¼Œç„¶åæ‹’ç»è¯·æ±‚ï¼›è‹¥å…¥å°äºå‡ºï¼Œåˆ™æ¼æ¡¶ä¸èµ·ä»»ä½•ä½œç”¨ã€‚\næ¼æ¡¶ä»¥å›ºå®šé€Ÿç‡æ¼å‡ºè¯·æ±‚æˆ–æ•°æ®åŒ…ï¼Œå¹³æ»‘çªå‘æµé‡ã€‚\nåŸºæœ¬å®ç° æ¯æ¬¡è¯·æ±‚èŠ±è´¹ x ç§’ (sleep)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 type state struct { last time.Time sleepFor time.Duration } type atomicLimiter struct { state unsafe.Pointer //lint:ignore U1000 Padding is unused but it is crucial to maintain performance // of this rate limiter in case of collocation with other frequently accessed memory. padding [56]byte // cache line size - state pointer size = 64 - 8; created to avoid false sharing. perRequest time.Duration maxSlack time.Duration clock Clock } // åˆå§‹åŒ–100qpsçš„é™æµå™¨ rl := ratelimit.New(100) // è®¡ç®—æ¯ä¸ªè¯·æ±‚éœ€è¦èŠ±å¤šå°‘ç§’ perRequest := config.per / time.Duration(rate) l := \u0026atomicLimiter{ perRequest: perRequest, // æ¯ä¸ªè¯·æ±‚è¦å¤šå°‘ç§’ maxSlack: -1 * time.Duration(config.slack) * perRequest, clock: config.clock, } // Take blocks to ensure that the time spent between multiple // Take calls is on average time.Second/rate. func (t *atomicLimiter) Take() time.Time { var ( newState state taken bool interval time.Duration ) for !taken { now := t.clock.Now() // åŠ è½½ä¸Šæ¬¡è¯·æ±‚çš„state previousStatePointer := atomic.LoadPointer(\u0026t.state) oldState := (*state)(previousStatePointer) // è®°å½•å½“å‰è¯·æ±‚çš„state newState = state{ last: now, sleepFor: oldState.sleepFor, } // If this is our first request, then we allow it. if oldState.last.IsZero() { taken = atomic.CompareAndSwapPointer(\u0026t.state, previousStatePointer, unsafe.Pointer(\u0026newState)) continue } // sleepFor calculates how much time we should sleep based on // the perRequest budget and how long the last request took. // Since the request may take longer than the budget, this number // can get negative, and is summed across requests. // è®¡ç®—è¿™æ¬¡è¿˜è¦sleepå¤šä¹… newState.sleepFor += t.perRequest - now.Sub(oldState.last) // We shouldn't allow sleepFor to get too negative, since it would mean that // a service that slowed down a lot for a short period of time would get // a much higher RPS following that. if newState.sleepFor \u003c t.maxSlack { newState.sleepFor = t.maxSlack } if newState.sleepFor \u003e 0 { newState.last = newState.last.Add(newState.sleepFor) interval, newState.sleepFor = newState.sleepFor, 0 } taken = atomic.CompareAndSwapPointer(\u0026t.state, previousStatePointer, unsafe.Pointer(\u0026newState)) } t.clock.Sleep(interval) return newState.last } 1. perRequest = æ¯ä¸¤ç§’ä¸€ä¸ªè¯·æ±‚ 2. oldState.last = ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´ç‚¹ 3. now.Sub(oldState.last) = è‡ªä»ä¸Šæ¬¡è¯·æ±‚åè¿‡äº†å¤šé•¿æ—¶é—´ 4. t.perRequest - now.Sub(oldState.last) = æˆ‘æƒ³è¦ä¸€ä¸ªè¯·æ±‚ï¼Œç°åœ¨è¿‡äº†è¿™ä¹ˆé•¿æ—¶é—´ï¼Œè¿˜å·®å¤šé•¿æ—¶é—´å¯ä»¥ä¸‹ä¸€æ¬¡è¯·æ±‚ 5. newState.sleepFor \u003e 0 è¯´æ˜æˆ‘è¿˜è¦sleep(newState.sleepFor) è¿™ä¹ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ¬¡è¯·æ±‚ 6. t.clock.Sleep(interval) æ‰§è¡Œsleep æ¼æ–—æ¡¶å®Œæ•´å®ç°\né—®é¢˜ çªå‘æ•ˆç‡\nå½“çŸ­æ—¶é—´å†…æœ‰å¤§é‡çªå‘è¯·æ±‚æ—¶ï¼Œå³ä¾¿æ­¤æ—¶æœåŠ¡å™¨æ²¡æœ‰ä»»ä½•è´Ÿè½½ï¼Œæ¯ä¸ªè¯·æ±‚ä¹Ÿå¾—åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰èƒ½è¢«å“åº”ï¼Œå¼¹æ€§ä¸å¤Ÿå¥½ã€‚\næ¼æ¡¶ç®—æ³•å¼ºåˆ¶ä¸€ä¸ªå¸¸é‡çš„è¾“å‡ºé€Ÿç‡è€Œä¸ç®¡è¾“å…¥æµé‡çš„çªå‘æ€§ï¼Œå¯¹äºå­˜åœ¨çªå‘ç‰¹æ€§çš„æµé‡æ¥è¯´ç¼ºä¹æ•ˆç‡ï¼›ä¸æ­¤åŒæ—¶ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•èƒ½é™åˆ¶æ•°æ®çš„å¹³å‡ä¼ è¾“é€Ÿç‡ä¹‹å¤–ï¼Œè¿˜å…è®¸æŸç§ç¨‹åº¦çš„æµé‡çªå‘ï¼Œå…è®¸æœ€å¤šæ¡¶å®¹é‡å¤§å°çš„çªå‘ï¼Œä½†ä»é•¿æœŸè¿è¡Œç»“æœæ¥çœ‹ï¼Œæµé‡é™åˆ¶ä¸ºå¸¸é‡ã€‚\nè‡ªé€‚åº”é™æµ ï¼ˆAdaptive Rate Limiterï¼‰ æ ¹æ®ç³»ç»Ÿèƒ½å¤Ÿæ‰¿è½½çš„æœ€å¤§ååé‡æ¥è¿›è¡Œé™æµï¼Œéœ€è¦ä¸€ä¸ªæ•°æ®æ¥è§¦å‘é˜ˆå€¼ï¼Œå¦‚æœºå™¨è´Ÿè½½ã€CPU ä½¿ç”¨ç‡ã€æ€»ä½“å¹³å‡å“åº”æ—¶é—´ã€å…¥å£ QPSã€å¹¶å‘çº¿ç¨‹æ•°ç­‰ è‡ªé€‚åº”é™æµç®—æ³•\nè‡ªé€‚åº”é™æµå®Œæ•´å®ç°\nPID ç®—æ³•ä¼˜åŒ– (PID Optimization) é˜²æ­¢å°æµé‡åœºæ™¯çš„è¯¯é™é—®é¢˜\nåŒºåˆ«äºä¼ ç»Ÿçº¿æ€§è°ƒèŠ‚ï¼Œä½¿ç”¨å¾®åˆ†å’Œç§¯åˆ†æ§åˆ¶ï¼Œä»ä¸åŒè§’åº¦å¤šå±‚æ¬¡è°ƒèŠ‚è¾“å…¥ï¼Œä½¿å¾—è°ƒèŠ‚æ›´å¿«çš„æ”¶æ•›\nå‚æ•° è§£é‡Š ç”¨é€” KP ç›®æ ‡å€¼å‡å»å½“å‰å€¼çš„ç³»æ•° ä»å®è§‚ä¸Šæ§åˆ¶æ‹’ç»æ¯”ä¾‹ä¸Šè°ƒè¿˜æ˜¯ä¸‹é™ KI å†å²è¯¯å·®çš„æ€»å’Œï¼ˆç§¯åˆ†ï¼‰çš„ç³»æ•° ä¹Ÿç§°ä¸ºç¨³æ€è¯¯å·®ç³»æ•°ï¼ŒåŠ ä¸Šå†å²è¯¯å·®ï¼Œé˜²æ­¢ç³»ç»Ÿåœ¨é˜ˆå€¼é™„è¿‘ä¸æ–­éœ‡è¡ï¼Œç»´æŒç³»ç»Ÿç¨³å®š KD è¯¯å·®åœ¨å½“å‰çš„æ—¶åˆ»çš„å¯¼æ•°ï¼ˆå¾®åˆ†ï¼‰çš„ç³»æ•° ä¸ºäº†èƒ½è®©ç³»ç»Ÿå¯¹äºçªå¢æƒ…å†µæ›´å¿«åšå‡ºååº” åˆ†å¸ƒå¼é™æµçš„å®ç° Redis setnx Redis + Lua Redis + list / zset Redis incr ä¾èµ– redis çš„åˆ†å¸ƒå¼é™æµä½¿ç”¨è®¡æ•°å™¨é™æµï¼Œincr å®ç°ç®€å•ï¼Œå¯¹ redis çš„æ“ä½œè¾ƒè½»ï¼Œä¸éœ€è¦åˆ†å¸ƒå¼é”ï¼Œä½†æ˜¯ä¼šå‡ºç°æµé‡é™¡å¢å¯¼è‡´é™æµè¾¹ç•Œè¶…è¿‡é˜ˆå€¼çš„é—®é¢˜ Go Redis åˆ†å¸ƒå¼é™æµåº“\nä½ QPS é«˜ç²¾åº¦ (~10k) å€ŸåŠ© Redis ä¸­å¿ƒåŒ–å­˜å‚¨ï¼ˆredis æ¡¶ï¼‰ï¼›æ¯ä¸ªæ—¶é—´æ®µä¸€ä¸ª redis keyï¼ˆå¦‚é™åˆ¶æ¯åˆ†é’Ÿè¯·æ±‚ 100 æ¬¡ï¼Œåˆ™ redis key ä¸º [prefix]_[minute_timestamp]ï¼›æ¯æ¬¡ä¸šåŠ¡å¤„ç†å‰ä½¿ç”¨ redis incr è·å–åˆ°çš„æ¬¡æ•°å’Œ limit å¯¹ç…§ï¼ˆç±»ä¼¼è®¡æ•°å™¨é™æµï¼‰\nå• key 10k QPS\né«˜ QPS ä½ç²¾åº¦ (100k+) æ ¸å¿ƒæ˜¯æ‰¹é‡è¯·æ±‚ + æœ¬åœ°ç¼“å­˜ + è‡ªæ—‹é”ï¼š\nä½¿ç”¨ä¸éœ€è¦å¤šæœºæˆ¿åŒæ­¥çš„ç‹¬ç«‹ redis é›†ç¾¤ä½œä¸ºé™æµçš„ä¸­å¿ƒèŠ‚ç‚¹ï¼Œåˆ†æœºæˆ¿é™æµï¼Œå…·å¤‡æ¨ªå‘æ‰©å±• sharding èƒ½åŠ› ä½¿ç”¨æœ¬åœ° token æ± å­˜æ”¾ step æ­¥é•¿é¢„å–ï¼Œä½¿ç”¨ incr by step æ–¹å¼è®¿é—® redisï¼ˆç›¸æ¯”äº decrï¼Œincr ä¸éœ€è¦ refreshï¼‰ incrby + expire è®¡æ•°å¹¶æ¸…ç†ï¼Œæ— éœ€é¢å¤–æ¸…ç† key æ­¥é•¿é¢„å–ä¸ºæœ¬åœ° cache çš„ counterï¼ˆæœ¬åœ°æ¡¶ï¼‰ï¼Œæ¯æ¬¡å– redis å¤šä¸ª counterï¼Œç¼“è§£å¯¹ redis è¯·æ±‚æš´æ¶¨å¸¦æ¥çš„å­˜å‚¨å‹åŠ›ï¼ˆçƒ­ key é—®é¢˜ä½¿å¾—é«˜ QPS ä¸‹ä¸å¾—ä¸é€€åŒ–æˆå•å®ä¾‹é™æµï¼‰ çƒ­ key é—®é¢˜ï¼šredis åˆ†ç‰‡ï¼Œkey å‰ç¼€å¢åŠ åˆ†ç‰‡å€¼ï¼Œå¯¹æ¯ä¸ªåˆ†ç‰‡å•ç‹¬è¿›è¡Œé™æµè®¡ç®— å¹¶å‘ä¼˜åŒ–ï¼šå…è®¸æœ¬åœ° token è¶…å‘ï¼Œåç»­ä¸€æ¬¡æ€§å‘ redis ç”³æŠ¥ é¢„å‘ tokenï¼Œå±è”½æ— é™æµé£é™©çš„ redis ç”³æŠ¥ Step æ­¥é•¿\nå¼•å…¥step æ­¥é•¿æ¦‚å¿µï¼Œé™æµæ¥å£çš„ä»¤ç‰Œæ•°é‡ä¾ç„¶åœ¨ redis ä¸­å­˜æ”¾ï¼Œä½†æ˜¯å–ä»¤ç‰Œæ•°é‡æ—¶ä¸åƒç²¾å‡†é™æµå™¨é‚£æ ·ä¸€æ¬¡å–ä¸€ä¸ªï¼Œè€Œæ˜¯ä»¥æ­¥é•¿ä¸ºå•ä½å»å–ï¼Œæ¯æ¬¡è·å–å•ä½æ­¥é•¿çš„ä»¤ç‰Œåˆ°æœ¬åœ°ç¼“å­˜ï¼Œæ–°çš„è¯·æ±‚è¿›å…¥éœ€è¦å…ˆå»æœ¬åœ°çš„ä»¤ç‰Œæ¡¶ä¸­è·å–ä»¤ç‰Œï¼Œå¦‚æœæœ¬åœ°ä»¤ç‰Œæ¡¶ä¸­æ¶ˆè€—å®Œä¹‹åéœ€è¦åˆ° redis æ¡¶ä¸­å†æ¬¡è·å–ç›´è‡³ redis æ¡¶ä¸­çš„ä»¤ç‰Œè¢«æ¶ˆè€—å®Œæ¯•ã€‚ Step = Min(QPS / 10k + 1, 10k) å• redis å®ä¾‹èƒ½å¤Ÿæ”¯æ’‘æœ€å¤§ 100k ç®€å•å‘½ä»¤ (incr) 100k QPS æ—¶ step ä¸ä¼šå¤ªå¤§è€Œé™ä½é™æµç²¾åº¦ 100m QPS æ—¶ï¼Œå• key è®¿é—® redis çš„é¢‘ç‡èƒ½å¤Ÿé™åˆ¶åœ¨ 100k ä»¥å†… 10b QPS æš‚æ— æ³•æ”¯æŒ é«˜ QPS é«˜ç²¾åº¦ æ‰“æ•£æ­¥é•¿ç­‰æ‰‹æ®µé™ä½ Redis è°ƒç”¨é‡ï¼Œé¿å…çƒ­ key é—®é¢˜ å¤§è§„æ¨¡é«˜ QPS ä½ç²¾åº¦: é›†ç¾¤é™æµ / å•å®ä¾‹é™æµ ä¾èµ– Service Mesh\né›†ç¾¤é™æµï¼šä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¯éš” 1 ms å¡«å……ï¼Œä¿è¯æ—¶é—´çª—å£å†…å‘æ”¾çš„æ€» quota æ˜¯é™æµé˜ˆå€¼ï¼Œæœ€ç»ˆè½åœ¨å•ä¸ªå®ä¾‹ä¸Šåšé™æµ\nå•å®ä¾‹é™æµï¼šå¯¹æ¯ä¸ªå®ä¾‹åšæœ¬åœ°é™æµé…ç½®ï¼ˆä»¤ç‰Œæ¡¶æˆ–æ»‘åŠ¨çª—å£ï¼‰\næ•æ„Ÿè€—æ—¶é™æµ æ–¹å¼ä¸€ï¼šä½¿ç”¨å•å®ä¾‹é™æµ\næ–¹å¼äºŒï¼šçº¯å¼‚æ­¥åˆ†å¸ƒå¼é™æµï¼Œå­˜åœ¨ä¸€å®šç¨‹åº¦æ¼é™ç‡\n","wordCount":"3688","inLanguage":"en","datePublished":"2021-05-04T00:00:00+08:00","dateModified":"2021-05-04T00:00:00+08:00","author":[{"@type":"Person","name":"HyperTars"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hypertars.com/posts/developer/distributed_systems/limiter/"},"publisher":{"@type":"Organization","name":"HyperTars' Blog","logo":{"@type":"ImageObject","url":"https://blog.hypertars.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://blog.hypertars.com accesskey=h title="HyperTars' Blog (Alt + H)">HyperTars' Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://hypertars.com title=ğŸ Home><span>ğŸ Home</span></a></li><li><a href=https://blog.hypertars.com/search/ title="ğŸ”Search (Alt + /)" accesskey=/><span>ğŸ”Search</span></a></li><li><a href=https://blog.hypertars.com/posts/developer/ title=ğŸ‘¨ğŸ»â€ğŸ’»Developer><span>ğŸ‘¨ğŸ»â€ğŸ’»Developer</span></a></li><li><a href=https://blog.hypertars.com/archives/ title=â±Archives><span>â±Archives</span></a></li><li><a href=https://blog.hypertars.com/tags/ title=ğŸ”–tags><span>ğŸ”–tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.hypertars.com>Home</a>&nbsp;Â»&nbsp;<a href=https://blog.hypertars.com/posts/>Articles</a>&nbsp;Â»&nbsp;<a href=https://blog.hypertars.com/posts/developer/>Developer</a>&nbsp;Â»&nbsp;<a href=https://blog.hypertars.com/posts/developer/distributed_systems/>Distributed System</a></div><h1 class=post-title>åˆ†å¸ƒå¼é™æµ</h1><div class=post-description>Introduction to distributed rate limiter</div><div class=post-meta><span title='2021-05-04 00:00:00 +0800 +0800'>2021-05-04</span>&nbsp;Â·&nbsp;8 min&nbsp;Â·&nbsp;HyperTars</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e9%99%90%e6%b5%81%e6%98%af%e4%bb%80%e4%b9%88 aria-label=é™æµæ˜¯ä»€ä¹ˆ>é™æµæ˜¯ä»€ä¹ˆ</a><ul><li><a href=#%e7%9f%a5%e8%af%86%e6%a0%91 aria-label=çŸ¥è¯†æ ‘>çŸ¥è¯†æ ‘</a></li></ul></li><li><a href=#%e5%b8%b8%e8%a7%81%e9%99%90%e6%b5%81%e6%96%b9%e5%bc%8f aria-label=å¸¸è§é™æµæ–¹å¼>å¸¸è§é™æµæ–¹å¼</a><ul><li><a href=#%e8%ae%a1%e6%95%b0%e5%99%a8%e9%99%90%e6%b5%81-count-based-rate-limiter aria-label="è®¡æ•°å™¨é™æµ (Count-based Rate Limiter)">è®¡æ•°å™¨é™æµ (Count-based Rate Limiter)</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e5%ae%9e%e7%8e%b0 aria-label=åŸºæœ¬å®ç°>åŸºæœ¬å®ç°</a></li><li><a href=#%e9%97%ae%e9%a2%98 aria-label=é—®é¢˜>é—®é¢˜</a></li></ul></li><li><a href=#%e6%bb%91%e5%8a%a8%e7%aa%97%e5%8f%a3%e8%ae%a1%e6%95%b0%e5%99%a8-sliding-window-rate-limiter aria-label="æ»‘åŠ¨çª—å£è®¡æ•°å™¨ (Sliding Window Rate Limiter)">æ»‘åŠ¨çª—å£è®¡æ•°å™¨ (Sliding Window Rate Limiter)</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e5%ae%9e%e7%8e%b0-1 aria-label=åŸºæœ¬å®ç°>åŸºæœ¬å®ç°</a></li><li><a href=#%e9%97%ae%e9%a2%98-1 aria-label=é—®é¢˜>é—®é¢˜</a></li></ul></li><li><a href=#%e4%bb%a4%e7%89%8c%e6%a1%b6-token-bucket-rate-limiter aria-label="ä»¤ç‰Œæ¡¶ (Token Bucket Rate Limiter)">ä»¤ç‰Œæ¡¶ (Token Bucket Rate Limiter)</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e5%ae%9e%e7%8e%b0-2 aria-label=åŸºæœ¬å®ç°>åŸºæœ¬å®ç°</a></li><li><a href=#%e9%97%ae%e9%a2%98-2 aria-label=é—®é¢˜>é—®é¢˜</a></li></ul></li><li><a href=#%e6%bc%8f%e6%96%97%e6%a1%b6-leaky-bucket-rate-limiter aria-label="æ¼æ–—æ¡¶ (Leaky Bucket Rate Limiter)">æ¼æ–—æ¡¶ (Leaky Bucket Rate Limiter)</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e5%ae%9e%e7%8e%b0-3 aria-label=åŸºæœ¬å®ç°>åŸºæœ¬å®ç°</a></li><li><a href=#%e9%97%ae%e9%a2%98-3 aria-label=é—®é¢˜>é—®é¢˜</a></li></ul></li><li><a href=#%e8%87%aa%e9%80%82%e5%ba%94%e9%99%90%e6%b5%81-adaptive-rate-limiter aria-label="è‡ªé€‚åº”é™æµ ï¼ˆAdaptive Rate Limiterï¼‰">è‡ªé€‚åº”é™æµ ï¼ˆAdaptive Rate Limiterï¼‰</a></li><li><a href=#pid-%e7%ae%97%e6%b3%95%e4%bc%98%e5%8c%96-pid-optimization aria-label="PID ç®—æ³•ä¼˜åŒ– (PID Optimization)">PID ç®—æ³•ä¼˜åŒ– (PID Optimization)</a></li></ul></li><li><a href=#%e5%88%86%e5%b8%83%e5%bc%8f%e9%99%90%e6%b5%81%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=åˆ†å¸ƒå¼é™æµçš„å®ç°>åˆ†å¸ƒå¼é™æµçš„å®ç°</a><ul><li><a href=#%e4%bd%8e-qps-%e9%ab%98%e7%b2%be%e5%ba%a6-10k aria-label="ä½ QPS é«˜ç²¾åº¦ (~10k)">ä½ QPS é«˜ç²¾åº¦ (~10k)</a></li><li><a href=#%e9%ab%98-qps-%e4%bd%8e%e7%b2%be%e5%ba%a6-100k aria-label="é«˜ QPS ä½ç²¾åº¦ (100k+)">é«˜ QPS ä½ç²¾åº¦ (100k+)</a></li><li><a href=#%e9%ab%98-qps-%e9%ab%98%e7%b2%be%e5%ba%a6 aria-label="é«˜ QPS é«˜ç²¾åº¦">é«˜ QPS é«˜ç²¾åº¦</a></li><li><a href=#%e5%a4%a7%e8%a7%84%e6%a8%a1%e9%ab%98-qps-%e4%bd%8e%e7%b2%be%e5%ba%a6-%e9%9b%86%e7%be%a4%e9%99%90%e6%b5%81--%e5%8d%95%e5%ae%9e%e4%be%8b%e9%99%90%e6%b5%81 aria-label="å¤§è§„æ¨¡é«˜ QPS ä½ç²¾åº¦: é›†ç¾¤é™æµ / å•å®ä¾‹é™æµ">å¤§è§„æ¨¡é«˜ QPS ä½ç²¾åº¦: é›†ç¾¤é™æµ / å•å®ä¾‹é™æµ</a></li><li><a href=#%e6%95%8f%e6%84%9f%e8%80%97%e6%97%b6%e9%99%90%e6%b5%81 aria-label=æ•æ„Ÿè€—æ—¶é™æµ>æ•æ„Ÿè€—æ—¶é™æµ</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener('DOMContentLoaded',function(){checkTocPosition(),elements=document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]'),activeElement=elements[0];const e=encodeURI(activeElement.getAttribute('id')).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add('active')},!1),window.addEventListener('resize',function(){checkTocPosition()},!1),window.addEventListener('scroll',()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute('id')).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add('active'):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove('active')})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue('--gap'),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=é™æµæ˜¯ä»€ä¹ˆ>é™æµæ˜¯ä»€ä¹ˆ<a hidden class=anchor aria-hidden=true href=#é™æµæ˜¯ä»€ä¹ˆ>#</a></h2><p>é«˜å¹¶å‘ç³»ç»Ÿåœ¨è¯·æ±‚è¿‡å¤šçš„æ—¶å€™ä¸»åŠ¨æ‹’ç»æœåŠ¡ã€‚</p><ul><li><p>é™æµï¼š<strong>ä¸»åŠ¨</strong>å¯¹è¶…è¿‡ä¸€å®šçš„è¯·æ±‚æµé‡è¿›è¡Œæ‹’ç»/ä¸¢å¼ƒ</p></li><li><p>é™çº§ï¼šå¯¹æ‰€æœ‰æµé‡è¿›è¡Œæ‹’ç»</p></li><li><p>è¿‡è½½ä¿æŠ¤ï¼šæ£€æµ‹åˆ°æœ¬èº«æœåŠ¡ï¼ˆcpuã€é”™è¯¯ç‡ï¼‰åˆ°è¾¾ä¸€å®šç¨‹åº¦ï¼Œåˆ¤æ–­å½“å‰æµé‡è¿‡å¤§ï¼Œ<strong>è¢«åŠ¨</strong>ä¿æŠ¤æœåŠ¡</p></li><li><p>ç†”æ–­ï¼šä¸ºäº†ä¿æŠ¤æœåŠ¡å™¨è‡ªå‘å‡å°‘æˆ–ä¸­æ–­è¯·æ±‚å‘æ”¾è¡Œä¸ºï¼ˆç†”æ–­ egressï¼Œè¿‡è½½ä¿æŠ¤ ingressï¼‰</p></li><li><p>Collaborative Admission Controlï¼šç»Ÿç­¹è¿‡è½½ä¿æŠ¤å’Œç†”æ–­</p></li></ul><h3 id=çŸ¥è¯†æ ‘>çŸ¥è¯†æ ‘<a hidden class=anchor aria-hidden=true href=#çŸ¥è¯†æ ‘>#</a></h3><ul><li>é™æµ<ul><li>å¯¹è±¡<ul><li>åŸºäºè¯·æ±‚é™æµï¼ˆQPSï¼‰</li><li>åŸºäºèµ„æºé™æµï¼ˆåº“å­˜ã€é‡‘é¢ï¼‰</li></ul></li><li>ä½ç½®<ul><li>æ¥å…¥å±‚é™æµï¼ˆnginxã€service meshï¼‰</li><li>åº”ç”¨å±‚é™æµ</li><li>å­˜å‚¨å±‚é™æµï¼ˆMySQLã€MongoDBï¼‰</li></ul></li><li>ç­–ç•¥<ul><li>åŸºäºç‰¹å¾ï¼ˆIPã€IDï¼‰</li><li>åŸºäºæ¥å£é™æµ</li></ul></li><li>ç²’åº¦<ul><li>å•æœºé™æµ</li><li>é›†ç¾¤é™æµ</li></ul></li><li>ç®—æ³•<ul><li>é˜Ÿåˆ—ï¼ˆé˜»å¡é˜Ÿåˆ—ã€æœ‰é™é˜Ÿåˆ—ã€ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼‰</li><li>è®¡æ•°ï¼ˆå›ºå®šçª—å£ã€æ»‘åŠ¨çª—å£ï¼‰</li><li>æ¼æ¡¶</li><li>ä»¤ç‰Œæ¡¶ï¼ˆå•é€ŸåŒæ¡¶ã€åŒé€ŸåŒæ¡¶ã€ä¸‰è‰²åŒæ¼æ¡¶ï¼‰</li></ul></li></ul></li></ul><h2 id=å¸¸è§é™æµæ–¹å¼>å¸¸è§é™æµæ–¹å¼<a hidden class=anchor aria-hidden=true href=#å¸¸è§é™æµæ–¹å¼>#</a></h2><h3 id=è®¡æ•°å™¨é™æµ-count-based-rate-limiter>è®¡æ•°å™¨é™æµ (Count-based Rate Limiter)<a hidden class=anchor aria-hidden=true href=#è®¡æ•°å™¨é™æµ-count-based-rate-limiter>#</a></h3><ul><li>åˆ†æ®µè®¡æ•°ï¼Œå›ºå®šæ—¶é—´çª—å£</li></ul><h4 id=åŸºæœ¬å®ç°>åŸºæœ¬å®ç°<a hidden class=anchor aria-hidden=true href=#åŸºæœ¬å®ç°>#</a></h4><img src=https://s3.us-west-1.amazonaws.com/images.hypertars.com/limiter/188ce9e8c95679707da4d49819503b7.png width=400 align=center><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#fff;font-weight:700>type</span> CountLimiter <span style=color:#fff;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>   counter      <span style=color:#fff;font-weight:700>int64</span>
</span></span><span style=display:flex><span>   limit        <span style=color:#fff;font-weight:700>int64</span>
</span></span><span style=display:flex><span>   intervalNano <span style=color:#fff;font-weight:700>int64</span>
</span></span><span style=display:flex><span>   unixNano     <span style=color:#fff;font-weight:700>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> NewCountLimiter(interval time.Duration, limit <span style=color:#fff;font-weight:700>int64</span>) *CountLimiter {
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>return</span> &amp;CountLimiter{
</span></span><span style=display:flex><span>      counter:      <span style=color:#ff0;font-weight:700>0</span>,
</span></span><span style=display:flex><span>      limit:        limit,
</span></span><span style=display:flex><span>      intervalNano: <span style=color:#fff;font-weight:700>int64</span>(interval),
</span></span><span style=display:flex><span>      unixNano:     time.Now().UnixNano(),
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> (c *CountLimiter) Allow() <span style=color:#fff;font-weight:700>bool</span> {
</span></span><span style=display:flex><span>   now := time.Now().UnixNano()
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>if</span> now-c.unixNano &gt; c.intervalNano {
</span></span><span style=display:flex><span>      atomic.StoreInt64(&amp;c.counter, <span style=color:#ff0;font-weight:700>0</span>)
</span></span><span style=display:flex><span>      atomic.StoreInt64(&amp;c.unixNano, now)
</span></span><span style=display:flex><span>      <span style=color:#fff;font-weight:700>return</span> <span style=color:#fff;font-weight:700>true</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   atomic.AddInt64(&amp;c.counter, <span style=color:#ff0;font-weight:700>1</span>)
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>return</span> c.counter &lt;= c.limit
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=é—®é¢˜>é—®é¢˜<a hidden class=anchor aria-hidden=true href=#é—®é¢˜>#</a></h4><p><strong>ç¬æ—¶æµé‡æ‹¥å¡</strong></p><p>çªå‘æµé‡å¯¼è‡´æ¯›åˆºç°è±¡ï¼Œé™æµä¸å‡†ç¡®</p><img src=https://s3.us-west-1.amazonaws.com/images.hypertars.com/limiter/477655f715e1362c5e0a62ff53026be.png width=400 align=center><h3 id=æ»‘åŠ¨çª—å£è®¡æ•°å™¨-sliding-window-rate-limiter>æ»‘åŠ¨çª—å£è®¡æ•°å™¨ (Sliding Window Rate Limiter)<a hidden class=anchor aria-hidden=true href=#æ»‘åŠ¨çª—å£è®¡æ•°å™¨-sliding-window-rate-limiter>#</a></h3><ul><li>é€šè¿‡æ›´ç»†ç²’åº¦çš„æ»‘åŠ¨çª—å£è®¡æ•°å™¨è§£å†³ç¬æ—¶æµé‡é—®é¢˜</li></ul><h4 id=åŸºæœ¬å®ç°-1>åŸºæœ¬å®ç°<a hidden class=anchor aria-hidden=true href=#åŸºæœ¬å®ç°-1>#</a></h4><ul><li>è®¾ç½®æˆæ›´å°çš„çª—å£ï¼Œæ›´ç»†ç²’åº¦é™åˆ¶æµé‡ï¼Œä½¿é™æµå˜å¾—å¹³æ»‘</li></ul><p>å¦‚å›¾ï¼Œæ¯ 60 ç§’è¯·æ±‚ 100 æ¬¡ï¼Œä¸€ä¸ªå¤§çª—å£åˆ†æˆ 6 ä¸ªå°çª—å£ï¼Œæ¯ä¸ªå°çª—å£å¯å®¹çº³ 10 æ¬¡è¯·æ±‚ã€‚</p><img src=https://s3.us-west-1.amazonaws.com/images.hypertars.com/limiter/ce2ad105ec234e534fff5fdde00b2cd.png width=300 align=center><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">60
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#fff;font-weight:700>var</span> once sync.Once
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>type</span> slidingWindowLimiter <span style=color:#fff;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>   curRequests      <span style=color:#fff;font-weight:700>int32</span>         <span style=color:#007f7f>// å½“å‰è¯·æ±‚å€¼
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>   durationRequests <span style=color:#fff;font-weight:700>chan</span> <span style=color:#fff;font-weight:700>int32</span>    <span style=color:#007f7f>// è¯·æ±‚é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>   accuracy         time.Duration <span style=color:#007f7f>// æ—¶é—´çª—å£æœ€å°å•å…ƒ
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>   snippet          time.Duration <span style=color:#007f7f>// æ—¶é—´çª—å£æ—¶é—´è·¨åº¦
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>   curRequestsSum   <span style=color:#fff;font-weight:700>int32</span>         <span style=color:#007f7f>// å½“å‰è¯·æ±‚æ•°ä¹‹å’Œ
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>   allowRequests    <span style=color:#fff;font-weight:700>int32</span>         <span style=color:#007f7f>// æœ€å¤§å…è®¸æ•°é‡
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> NewSlidingWindowLimiter(accuracy, snippet time.Duration, allowRequests <span style=color:#fff;font-weight:700>int32</span>) *slidingWindowLimiter {
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>return</span> &amp;slidingWindowLimiter{
</span></span><span style=display:flex><span>      durationRequests: <span style=color:#fff;font-weight:700>make</span>(<span style=color:#fff;font-weight:700>chan</span> <span style=color:#fff;font-weight:700>int32</span>, snippet/accuracy),
</span></span><span style=display:flex><span>      accuracy:         accuracy,
</span></span><span style=display:flex><span>      snippet:          snippet,
</span></span><span style=display:flex><span>      allowRequests:    allowRequests,
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> (s *slidingWindowLimiter) Take() <span style=color:#fff;font-weight:700>error</span> {
</span></span><span style=display:flex><span>   once.Do(<span style=color:#fff;font-weight:700>func</span>() { <span style=color:#007f7f>// å¾€å‰åˆ’åŠ¨ä¸€ä¸ªæœ€å°æ—¶é—´çª—å£
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>      <span style=color:#fff;font-weight:700>go</span> sliding(s)
</span></span><span style=display:flex><span>      <span style=color:#fff;font-weight:700>go</span> calculate(s)
</span></span><span style=display:flex><span>   })
</span></span><span style=display:flex><span>   curRequest := atomic.LoadInt32(&amp;s.curRequestsSum)
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>if</span> curRequest &gt;= s.allowRequests {
</span></span><span style=display:flex><span>      <span style=color:#fff;font-weight:700>return</span> ratelimit_kit.ErrExceededLimit
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>if</span> !atomic.CompareAndSwapInt32(&amp;s.curRequestsSum, curRequest, curRequest+<span style=color:#ff0;font-weight:700>1</span>) { <span style=color:#007f7f>//cas
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>      <span style=color:#fff;font-weight:700>return</span> ratelimit_kit.ErrExceededLimit
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   atomic.AddInt32(&amp;s.curRequests, <span style=color:#ff0;font-weight:700>1</span>)
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>return</span> <span style=color:#fff;font-weight:700>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> sliding(s *slidingWindowLimiter) {
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>for</span> {
</span></span><span style=display:flex><span>      <span style=color:#fff;font-weight:700>select</span> {
</span></span><span style=display:flex><span>      <span style=color:#fff;font-weight:700>case</span> &lt;-time.After(s.accuracy):
</span></span><span style=display:flex><span>         s.durationRequests &lt;- atomic.SwapInt32(&amp;s.curRequests, <span style=color:#ff0;font-weight:700>0</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> calculate(s *slidingWindowLimiter) {
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>for</span> {
</span></span><span style=display:flex><span>      &lt;-time.After(s.accuracy)
</span></span><span style=display:flex><span>      <span style=color:#fff;font-weight:700>if</span> <span style=color:#fff;font-weight:700>len</span>(s.durationRequests) == <span style=color:#fff;font-weight:700>cap</span>(s.durationRequests) { <span style=color:#007f7f>// channelæ»¡äº†
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>         <span style=color:#fff;font-weight:700>break</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#fff;font-weight:700>for</span> {
</span></span><span style=display:flex><span>      &lt;-time.After(s.accuracy)
</span></span><span style=display:flex><span>      t := &lt;-s.durationRequests
</span></span><span style=display:flex><span>      <span style=color:#fff;font-weight:700>if</span> t != <span style=color:#ff0;font-weight:700>0</span> {
</span></span><span style=display:flex><span>         atomic.AddInt32(&amp;s.curRequestsSum, -t)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><img src=https://s3.us-west-1.amazonaws.com/images.hypertars.com/limiter/slidingwindow.png width=300 align=center><p><a href=https://github.com/RussellLuo/slidingwindow>æ»‘åŠ¨çª—å£è®¡æ•°å™¨é™æµå®Œæ•´å®ç° 1</a></p><p><a href=https://github.com/ulovecode/ratelimit-kit>æ»‘åŠ¨çª—å£è®¡æ•°å™¨é™æµå®Œæ•´å®ç° 2</a></p><h4 id=é—®é¢˜-1>é—®é¢˜<a hidden class=anchor aria-hidden=true href=#é—®é¢˜-1>#</a></h4><p>æ—¶é—´åŒºé—´çš„ç²¾åº¦è¶Šé«˜ï¼Œç®—æ³•æ‰€éœ€çš„ç©ºé—´å®¹é‡å°±è¶Šå¤§ã€‚</p><p>å®ç°ç¨å¾®å¤æ‚ä½†æ˜¯ä¾ç„¶ä¸èƒ½è§£å†³è®¡æ•°å™¨è¾¹ç•Œé—®é¢˜</p><h3 id=ä»¤ç‰Œæ¡¶-token-bucket-rate-limiter>ä»¤ç‰Œæ¡¶ (Token Bucket Rate Limiter)<a hidden class=anchor aria-hidden=true href=#ä»¤ç‰Œæ¡¶-token-bucket-rate-limiter>#</a></h3><ul><li><p>é™åˆ¶è¾“å…¥é€Ÿç‡</p></li><li><p>ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯ç½‘ç»œæµé‡æ•´å½¢ Traffic Shaping å’Œé€Ÿç‡é™åˆ¶ Rate Limiting ä¸­æœ€å¸¸ä½¿ç”¨çš„ä¸€ç§ç®—æ³•</p></li><li><p>ä»¤ç‰Œæ¡¶åŸºæœ¬å¤„ç†æµç¨‹</p><ul><li>äº§ç”Ÿä»¤ç‰Œï¼šå‘¨æœŸæ€§åœ°ä»¥ä¸€å®šé€Ÿç‡ï¼ˆå¦‚ 100msï¼‰å¾€ä»¤ç‰Œæ¡¶ä¸­å¢åŠ ä»¤ç‰Œï¼›å¦‚æœä»¤ç‰Œæ»¡äº†ï¼Œä¸¢å¼ƒå¤šä½™ä»¤ç‰Œ<ul><li><a href=https://patents.google.com/patent/CN1536815A/zh%EF%BC%89>æ”¹è¿›ç®—æ³•å®æ—¶æ·»åŠ ä»¤ç‰Œæ•°</a></li></ul></li><li>æ¶ˆè€—ä»¤ç‰Œï¼šè¯·æ±‚æ¥æ—¶ï¼Œä»æ¡¶ä¸­å–ä»¤ç‰Œï¼›å¦‚æœå–åˆ°æ‰€éœ€æ•°é‡ä»¤ç‰Œï¼Œåˆ™é€šè¿‡ï¼›å¦‚æœå–ä¸åˆ°ï¼Œåˆ™é™æµ</li><li>æ˜¯å¦é€šè¿‡ï¼šæ¡¶ä¸­çš„ä»¤ç‰Œ >= æ‰€éœ€ä»¤ç‰Œï¼Œå¦åˆ™ï¼šç›´æ¥ä¸¢å¼ƒ / è¿›é˜Ÿåˆ—ç­‰å¾… / å¯ä»¥é€šè¿‡ä½†éœ€è¦ç‰¹æ®Šæ ‡è®°</li></ul></li></ul><h4 id=åŸºæœ¬å®ç°-2>åŸºæœ¬å®ç°<a hidden class=anchor aria-hidden=true href=#åŸºæœ¬å®ç°-2>#</a></h4><img src=https://s3.us-west-1.amazonaws.com/images.hypertars.com/limiter/9413db7b52910adf1f65368ec313f38.png width=400 align=center><ul><li>å®é™…å®ç°é‡‡ç”¨æ¯æ¬¡å–ä»¤ç‰Œçš„æ—¶å€™ç»Ÿè®¡ä¸ä¸Šæ¬¡è¯·æ±‚çš„ tickï¼Œæ¯æ¬¡å®æ—¶æ›´æ–°ï¼ˆè€Œéå‘¨æœŸæ€§å¾€æ¡¶ä¸­å¢åŠ ä»¤ç‰Œï¼‰</li></ul><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">64
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#007f7f>// æ¯fillIntervalæ—¶é—´é—´éš”å¡«å……1ä¸ªtoken
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span><span style=color:#fff;font-weight:700>func</span> NewBucket(fillInterval time.Duration, capacity <span style=color:#fff;font-weight:700>int64</span>) *Bucket {
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>return</span> NewBucketWithClock(fillInterval, capacity, <span style=color:#fff;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>return</span> &amp;Bucket{
</span></span><span style=display:flex><span>    clock:           clock, <span style=color:#007f7f>// for mock
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    startTime:       clock.Now(), <span style=color:#007f7f>// å¯åŠ¨æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    latestTick:      <span style=color:#ff0;font-weight:700>0</span>, <span style=color:#007f7f>//æœ€åçš„tick
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    fillInterval:    fillInterval, <span style=color:#007f7f>// æ¯éš”å¤šä¹…
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    capacity:        capacity, <span style=color:#007f7f>// æœ€å¤§çš„å®¹é‡
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    quantum:         quantum, <span style=color:#007f7f>// æ”¾å…¥quantumä¸ªtoken
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    availableTokens: capacity, <span style=color:#007f7f>// å½“å‰å¯ç”¨tokenï¼ˆåˆå§‹åŒ–ä¸ºå®¹é‡
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007f7f>// take token
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span><span style=color:#fff;font-weight:700>func</span> (tb *Bucket) take(now time.Time, count <span style=color:#fff;font-weight:700>int64</span>, maxWait time.Duration) (time.Duration, <span style=color:#fff;font-weight:700>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>if</span> count &lt;= <span style=color:#ff0;font-weight:700>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>return</span> <span style=color:#ff0;font-weight:700>0</span>, <span style=color:#fff;font-weight:700>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tick := tb.currentTick(now)
</span></span><span style=display:flex><span>    tb.adjustavailableTokens(tick)
</span></span><span style=display:flex><span>    avail := tb.availableTokens - count
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>if</span> avail &gt;= <span style=color:#ff0;font-weight:700>0</span> {
</span></span><span style=display:flex><span>        tb.availableTokens = avail
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>return</span> <span style=color:#ff0;font-weight:700>0</span>, <span style=color:#fff;font-weight:700>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#007f7f>// Round up the missing tokens to the nearest multiple
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    <span style=color:#007f7f>// of quantum - the tokens won&#39;t be available until
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    <span style=color:#007f7f>// that tick.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>
</span></span><span style=display:flex><span>    <span style=color:#007f7f>// endTick holds the tick when all the requested tokens will
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    <span style=color:#007f7f>// become available.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    endTick := tick + (-avail+tb.quantum-<span style=color:#ff0;font-weight:700>1</span>)/tb.quantum
</span></span><span style=display:flex><span>    endTime := tb.startTime.Add(time.Duration(endTick) * tb.fillInterval)
</span></span><span style=display:flex><span>    waitTime := endTime.Sub(now)
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>if</span> waitTime &gt; maxWait {
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>return</span> <span style=color:#ff0;font-weight:700>0</span>, <span style=color:#fff;font-weight:700>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    tb.availableTokens = avail
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>return</span> waitTime, <span style=color:#fff;font-weight:700>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007f7f>// è®¡ç®—ä»ä»¤ç‰Œæ¡¶å¼€å§‹ç»è¿‡äº†å¤šå°‘ä¸ªtick ï¼ˆæ¯éš”tickä¼šå¡«å……quantumçš„token
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span><span style=color:#fff;font-weight:700>func</span> (tb *Bucket) currentTick(now time.Time) <span style=color:#fff;font-weight:700>int64</span> {
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>return</span> <span style=color:#fff;font-weight:700>int64</span>(now.Sub(tb.startTime) / tb.fillInterval)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007f7f>// è®¡ç®—ä»ä¸Šä¸€æ¬¡tickåˆ°ç°åœ¨ç»è¿‡äº†å¤šå°‘ä¸ªtickï¼Œtick*quantum+availableç­‰äºç›®å‰å¯ä»¥ä½¿ç”¨çš„tokenæ•°é‡
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span><span style=color:#fff;font-weight:700>func</span> (tb *Bucket) adjustavailableTokens(tick <span style=color:#fff;font-weight:700>int64</span>) {
</span></span><span style=display:flex><span>    lastTick := tb.latestTick
</span></span><span style=display:flex><span>    tb.latestTick = tick
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>if</span> tb.availableTokens &gt;= tb.capacity {
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    tb.availableTokens += (tick - lastTick) * tb.quantum
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>if</span> tb.availableTokens &gt; tb.capacity {
</span></span><span style=display:flex><span>        tb.availableTokens = tb.capacity
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>æ¯æ¬¡éƒ½ä¼šæ›´æ–°å½“å‰å¯ç”¨çš„æ•°é‡<span style=color:red>ï¼ˆ</span>è¯»è§¦å‘<span style=color:red>ï¼‰ï¼Œ</span>å†å‡å»éœ€æ±‚é‡
</span></span></code></pre></td></tr></table></div></div><p><a href=https://golang.org/x/time/rate>ä»¤ç‰Œæ¡¶å®Œæ•´å®ç° 1</a></p><p><a href=https://github.com/juju/ratelimit>ä»¤ç‰Œæ¡¶å®Œæ•´å®ç° 2</a></p><h4 id=é—®é¢˜-2>é—®é¢˜<a hidden class=anchor aria-hidden=true href=#é—®é¢˜-2>#</a></h4><p><strong>çªåˆºé—®é¢˜</strong></p><p>åœ¨æœåŠ¡å™¨èµ„æºç©ºé—²çš„çŠ¶æ€ä¸‹ä¼šé€ æˆæå¤§çš„æµªè´¹</p><img src=https://s3.us-west-1.amazonaws.com/images.hypertars.com/limiter/284508c796161348858015d7af57403.jpg width=300 align=center><h3 id=æ¼æ–—æ¡¶-leaky-bucket-rate-limiter>æ¼æ–—æ¡¶ (Leaky Bucket Rate Limiter)<a hidden class=anchor aria-hidden=true href=#æ¼æ–—æ¡¶-leaky-bucket-rate-limiter>#</a></h3><ul><li><p>é™åˆ¶è¾“å‡ºé€Ÿç‡</p></li><li><p>è¯·æ±‚ç±»ä¼¼æ°´æµï¼Œå…ˆè¿›å…¥æ¼æ¡¶ä¸­ï¼Œæ¼æ¡¶ä»¥ä¸€å®šçš„é€Ÿç‡å‡ºæ°´ï¼ˆæ¥å£å“åº”é€Ÿç‡ï¼‰ï¼Œå½“æ°´æµé€Ÿç‡è¿‡å¤§ä¼šç›´æ¥æº¢å‡ºï¼ˆè®¿é—®é¢‘ç‡è¶…è¿‡æ¥å£å“åº”é€Ÿç‡ï¼‰ï¼Œç„¶åæ‹’ç»è¯·æ±‚ï¼›è‹¥å…¥å°äºå‡ºï¼Œåˆ™æ¼æ¡¶ä¸èµ·ä»»ä½•ä½œç”¨ã€‚</p></li><li><p>æ¼æ¡¶ä»¥å›ºå®šé€Ÿç‡æ¼å‡ºè¯·æ±‚æˆ–æ•°æ®åŒ…ï¼Œå¹³æ»‘çªå‘æµé‡ã€‚</p></li></ul><h4 id=åŸºæœ¬å®ç°-3>åŸºæœ¬å®ç°<a hidden class=anchor aria-hidden=true href=#åŸºæœ¬å®ç°-3>#</a></h4><p>æ¯æ¬¡è¯·æ±‚èŠ±è´¹ x ç§’ (sleep)</p><img src=https://s3.us-west-1.amazonaws.com/images.hypertars.com/limiter/8410022a839cb8be1a46972565dc992.png width=300 align=center><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">81
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#fff;font-weight:700>type</span> state <span style=color:#fff;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>        last     time.Time
</span></span><span style=display:flex><span>        sleepFor time.Duration
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>type</span> atomicLimiter <span style=color:#fff;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>        state unsafe.Pointer
</span></span><span style=display:flex><span>        <span style=color:#007f7f>//lint:ignore U1000 Padding is unused but it is crucial to maintain performance
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#007f7f>// of this rate limiter in case of collocation with other frequently accessed memory.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        padding [<span style=color:#ff0;font-weight:700>56</span>]<span style=color:#fff;font-weight:700>byte</span> <span style=color:#007f7f>// cache line size - state pointer size = 64 - 8; created to avoid false sharing.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>
</span></span><span style=display:flex><span>        perRequest time.Duration
</span></span><span style=display:flex><span>        maxSlack   time.Duration
</span></span><span style=display:flex><span>        clock      Clock
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007f7f>// åˆå§‹åŒ–100qpsçš„é™æµå™¨
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>rl := ratelimit.New(<span style=color:#ff0;font-weight:700>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007f7f>// è®¡ç®—æ¯ä¸ªè¯·æ±‚éœ€è¦èŠ±å¤šå°‘ç§’
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>perRequest := config.per / time.Duration(rate)
</span></span><span style=display:flex><span>l := &amp;atomicLimiter{
</span></span><span style=display:flex><span>    perRequest: perRequest, <span style=color:#007f7f>// æ¯ä¸ªè¯·æ±‚è¦å¤šå°‘ç§’
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    maxSlack:   -<span style=color:#ff0;font-weight:700>1</span> * time.Duration(config.slack) * perRequest,
</span></span><span style=display:flex><span>    clock:      config.clock,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007f7f>// Take blocks to ensure that the time spent between multiple
</span></span></span><span style=display:flex><span><span style=color:#007f7f>// Take calls is on average time.Second/rate.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span><span style=color:#fff;font-weight:700>func</span> (t *atomicLimiter) Take() time.Time {
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>var</span> (
</span></span><span style=display:flex><span>        newState state
</span></span><span style=display:flex><span>        taken    <span style=color:#fff;font-weight:700>bool</span>
</span></span><span style=display:flex><span>        interval time.Duration
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>for</span> !taken {
</span></span><span style=display:flex><span>        now := t.clock.Now()
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// åŠ è½½ä¸Šæ¬¡è¯·æ±‚çš„state
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        previousStatePointer := atomic.LoadPointer(&amp;t.state)
</span></span><span style=display:flex><span>        oldState := (*state)(previousStatePointer)
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// è®°å½•å½“å‰è¯·æ±‚çš„state
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        newState = state{
</span></span><span style=display:flex><span>            last:     now,
</span></span><span style=display:flex><span>            sleepFor: oldState.sleepFor,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// If this is our first request, then we allow it.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#fff;font-weight:700>if</span> oldState.last.IsZero() {
</span></span><span style=display:flex><span>            taken = atomic.CompareAndSwapPointer(&amp;t.state, previousStatePointer, unsafe.Pointer(&amp;newState))
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// sleepFor calculates how much time we should sleep based on
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#007f7f>// the perRequest budget and how long the last request took.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#007f7f>// Since the request may take longer than the budget, this number
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#007f7f>// can get negative, and is summed across requests.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#007f7f>// è®¡ç®—è¿™æ¬¡è¿˜è¦sleepå¤šä¹…
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        newState.sleepFor += t.perRequest - now.Sub(oldState.last)
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// We shouldn&#39;t allow sleepFor to get too negative, since it would mean that
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#007f7f>// a service that slowed down a lot for a short period of time would get
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#007f7f>// a much higher RPS following that.
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>        <span style=color:#fff;font-weight:700>if</span> newState.sleepFor &lt; t.maxSlack {
</span></span><span style=display:flex><span>            newState.sleepFor = t.maxSlack
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>if</span> newState.sleepFor &gt; <span style=color:#ff0;font-weight:700>0</span> {
</span></span><span style=display:flex><span>            newState.last = newState.last.Add(newState.sleepFor)
</span></span><span style=display:flex><span>            interval, newState.sleepFor = newState.sleepFor, <span style=color:#ff0;font-weight:700>0</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        taken = atomic.CompareAndSwapPointer(&amp;t.state, previousStatePointer, unsafe.Pointer(&amp;newState))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    t.clock.Sleep(interval)
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>return</span> newState.last
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff0;font-weight:700>1.</span> perRequest = æ¯ä¸¤ç§’ä¸€ä¸ªè¯·æ±‚
</span></span><span style=display:flex><span><span style=color:#ff0;font-weight:700>2.</span> oldState.last = ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´ç‚¹
</span></span><span style=display:flex><span><span style=color:#ff0;font-weight:700>3.</span> now.Sub(oldState.last) = è‡ªä»ä¸Šæ¬¡è¯·æ±‚åè¿‡äº†å¤šé•¿æ—¶é—´
</span></span><span style=display:flex><span><span style=color:#ff0;font-weight:700>4.</span> t.perRequest - now.Sub(oldState.last) 
</span></span><span style=display:flex><span>  = æˆ‘æƒ³è¦ä¸€ä¸ªè¯·æ±‚<span style=color:red>ï¼Œ</span>ç°åœ¨è¿‡äº†è¿™ä¹ˆé•¿æ—¶é—´<span style=color:red>ï¼Œ</span>è¿˜å·®å¤šé•¿æ—¶é—´å¯ä»¥ä¸‹ä¸€æ¬¡è¯·æ±‚
</span></span><span style=display:flex><span><span style=color:#ff0;font-weight:700>5.</span> newState.sleepFor &gt; <span style=color:#ff0;font-weight:700>0</span> è¯´æ˜æˆ‘è¿˜è¦sleep(newState.sleepFor) è¿™ä¹ˆé•¿æ—¶é—´<span style=color:red>ï¼Œ</span>æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ¬¡è¯·æ±‚
</span></span><span style=display:flex><span><span style=color:#ff0;font-weight:700>6.</span> t.clock.Sleep(interval) æ‰§è¡Œsleep
</span></span></code></pre></td></tr></table></div></div><p><a href=https://github.com/uber-go/ratelimit>æ¼æ–—æ¡¶å®Œæ•´å®ç°</a></p><h4 id=é—®é¢˜-3>é—®é¢˜<a hidden class=anchor aria-hidden=true href=#é—®é¢˜-3>#</a></h4><p><strong>çªå‘æ•ˆç‡</strong></p><p>å½“çŸ­æ—¶é—´å†…æœ‰å¤§é‡çªå‘è¯·æ±‚æ—¶ï¼Œå³ä¾¿æ­¤æ—¶æœåŠ¡å™¨æ²¡æœ‰ä»»ä½•è´Ÿè½½ï¼Œæ¯ä¸ªè¯·æ±‚ä¹Ÿå¾—åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰èƒ½è¢«å“åº”ï¼Œå¼¹æ€§ä¸å¤Ÿå¥½ã€‚</p><p>æ¼æ¡¶ç®—æ³•å¼ºåˆ¶ä¸€ä¸ªå¸¸é‡çš„è¾“å‡ºé€Ÿç‡è€Œä¸ç®¡è¾“å…¥æµé‡çš„çªå‘æ€§ï¼Œå¯¹äºå­˜åœ¨çªå‘ç‰¹æ€§çš„æµé‡æ¥è¯´ç¼ºä¹æ•ˆç‡ï¼›ä¸æ­¤åŒæ—¶ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•èƒ½é™åˆ¶æ•°æ®çš„å¹³å‡ä¼ è¾“é€Ÿç‡ä¹‹å¤–ï¼Œè¿˜å…è®¸æŸç§ç¨‹åº¦çš„æµé‡çªå‘ï¼Œå…è®¸æœ€å¤šæ¡¶å®¹é‡å¤§å°çš„çªå‘ï¼Œä½†ä»é•¿æœŸè¿è¡Œç»“æœæ¥çœ‹ï¼Œæµé‡é™åˆ¶ä¸ºå¸¸é‡ã€‚</p><h3 id=è‡ªé€‚åº”é™æµ-adaptive-rate-limiter>è‡ªé€‚åº”é™æµ ï¼ˆAdaptive Rate Limiterï¼‰<a hidden class=anchor aria-hidden=true href=#è‡ªé€‚åº”é™æµ-adaptive-rate-limiter>#</a></h3><ul><li>æ ¹æ®ç³»ç»Ÿèƒ½å¤Ÿæ‰¿è½½çš„æœ€å¤§ååé‡æ¥è¿›è¡Œé™æµï¼Œéœ€è¦ä¸€ä¸ªæ•°æ®æ¥è§¦å‘é˜ˆå€¼ï¼Œå¦‚æœºå™¨è´Ÿè½½ã€CPU ä½¿ç”¨ç‡ã€æ€»ä½“å¹³å‡å“åº”æ—¶é—´ã€å…¥å£ QPSã€å¹¶å‘çº¿ç¨‹æ•°ç­‰</li></ul><p><a href=https://www.coonote.com/architecture/sentinel-adaptive-current-limiting.html>è‡ªé€‚åº”é™æµç®—æ³•</a></p><p><a href=https://github.com/alibaba/sentinel-golang/tree/master/core/system>è‡ªé€‚åº”é™æµå®Œæ•´å®ç°</a></p><h3 id=pid-ç®—æ³•ä¼˜åŒ–-pid-optimization>PID ç®—æ³•ä¼˜åŒ– (PID Optimization)<a hidden class=anchor aria-hidden=true href=#pid-ç®—æ³•ä¼˜åŒ–-pid-optimization>#</a></h3><ul><li><p>é˜²æ­¢å°æµé‡åœºæ™¯çš„è¯¯é™é—®é¢˜</p></li><li><p>åŒºåˆ«äºä¼ ç»Ÿçº¿æ€§è°ƒèŠ‚ï¼Œä½¿ç”¨å¾®åˆ†å’Œç§¯åˆ†æ§åˆ¶ï¼Œä»ä¸åŒè§’åº¦å¤šå±‚æ¬¡è°ƒèŠ‚è¾“å…¥ï¼Œä½¿å¾—è°ƒèŠ‚æ›´å¿«çš„æ”¶æ•›</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>è§£é‡Š</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td>KP</td><td>ç›®æ ‡å€¼å‡å»å½“å‰å€¼çš„ç³»æ•°</td><td>ä»å®è§‚ä¸Šæ§åˆ¶æ‹’ç»æ¯”ä¾‹ä¸Šè°ƒè¿˜æ˜¯ä¸‹é™</td></tr><tr><td>KI</td><td>å†å²è¯¯å·®çš„æ€»å’Œï¼ˆç§¯åˆ†ï¼‰çš„ç³»æ•°</td><td>ä¹Ÿç§°ä¸ºç¨³æ€è¯¯å·®ç³»æ•°ï¼ŒåŠ ä¸Šå†å²è¯¯å·®ï¼Œé˜²æ­¢ç³»ç»Ÿåœ¨é˜ˆå€¼é™„è¿‘ä¸æ–­éœ‡è¡ï¼Œç»´æŒç³»ç»Ÿç¨³å®š</td></tr><tr><td>KD</td><td>è¯¯å·®åœ¨å½“å‰çš„æ—¶åˆ»çš„å¯¼æ•°ï¼ˆå¾®åˆ†ï¼‰çš„ç³»æ•°</td><td>ä¸ºäº†èƒ½è®©ç³»ç»Ÿå¯¹äºçªå¢æƒ…å†µæ›´å¿«åšå‡ºååº”</td></tr></tbody></table><img src=https://s3.us-west-1.amazonaws.com/images.hypertars.com/limiter/3f13f36b708f925fd23476c7806212b.jpg width=300 align=center><h2 id=åˆ†å¸ƒå¼é™æµçš„å®ç°>åˆ†å¸ƒå¼é™æµçš„å®ç°<a hidden class=anchor aria-hidden=true href=#åˆ†å¸ƒå¼é™æµçš„å®ç°>#</a></h2><ol><li>Redis setnx</li><li>Redis + Lua</li><li>Redis + list / zset</li><li>Redis incr</li></ol><ul><li>ä¾èµ– redis çš„åˆ†å¸ƒå¼é™æµä½¿ç”¨<strong>è®¡æ•°å™¨é™æµ</strong>ï¼Œ<code>incr</code> å®ç°ç®€å•ï¼Œå¯¹ redis çš„æ“ä½œè¾ƒè½»ï¼Œä¸éœ€è¦åˆ†å¸ƒå¼é”ï¼Œä½†æ˜¯ä¼šå‡ºç°æµé‡é™¡å¢å¯¼è‡´é™æµè¾¹ç•Œè¶…è¿‡é˜ˆå€¼çš„é—®é¢˜</li></ul><p><a href=https://github.com/go-redis/redis_rate>Go Redis åˆ†å¸ƒå¼é™æµåº“</a></p><h3 id=ä½-qps-é«˜ç²¾åº¦-10k>ä½ QPS é«˜ç²¾åº¦ (~10k)<a hidden class=anchor aria-hidden=true href=#ä½-qps-é«˜ç²¾åº¦-10k>#</a></h3><ul><li><p>å€ŸåŠ© Redis ä¸­å¿ƒåŒ–å­˜å‚¨ï¼ˆredis æ¡¶ï¼‰ï¼›æ¯ä¸ªæ—¶é—´æ®µä¸€ä¸ª redis keyï¼ˆå¦‚é™åˆ¶æ¯åˆ†é’Ÿè¯·æ±‚ 100 æ¬¡ï¼Œåˆ™ redis key ä¸º <code>[prefix]_[minute_timestamp]</code>ï¼›æ¯æ¬¡ä¸šåŠ¡å¤„ç†å‰ä½¿ç”¨ <code>redis incr</code> è·å–åˆ°çš„æ¬¡æ•°å’Œ limit å¯¹ç…§ï¼ˆç±»ä¼¼<strong>è®¡æ•°å™¨é™æµ</strong>ï¼‰</p></li><li><p>å• key 10k QPS</p></li></ul><h3 id=é«˜-qps-ä½ç²¾åº¦-100k>é«˜ QPS ä½ç²¾åº¦ (100k+)<a hidden class=anchor aria-hidden=true href=#é«˜-qps-ä½ç²¾åº¦-100k>#</a></h3><ul><li><p>æ ¸å¿ƒæ˜¯<strong>æ‰¹é‡è¯·æ±‚ + æœ¬åœ°ç¼“å­˜ + è‡ªæ—‹é”</strong>ï¼š</p><ul><li>ä½¿ç”¨ä¸éœ€è¦å¤šæœºæˆ¿åŒæ­¥çš„ç‹¬ç«‹ redis é›†ç¾¤ä½œä¸ºé™æµçš„ä¸­å¿ƒèŠ‚ç‚¹ï¼Œåˆ†æœºæˆ¿é™æµï¼Œå…·å¤‡æ¨ªå‘æ‰©å±• sharding èƒ½åŠ›</li><li>ä½¿ç”¨æœ¬åœ° token æ± å­˜æ”¾ step æ­¥é•¿é¢„å–ï¼Œä½¿ç”¨ <code>incr by step</code> æ–¹å¼è®¿é—® redisï¼ˆç›¸æ¯”äº <code>decr</code>ï¼Œ<code>incr</code> ä¸éœ€è¦ refreshï¼‰</li><li><code>incrby</code> + <code>expire</code> è®¡æ•°å¹¶æ¸…ç†ï¼Œæ— éœ€é¢å¤–æ¸…ç† key</li><li>æ­¥é•¿é¢„å–ä¸ºæœ¬åœ° cache çš„ counterï¼ˆæœ¬åœ°æ¡¶ï¼‰ï¼Œæ¯æ¬¡å– redis å¤šä¸ª counterï¼Œç¼“è§£å¯¹ redis è¯·æ±‚æš´æ¶¨å¸¦æ¥çš„å­˜å‚¨å‹åŠ›ï¼ˆçƒ­ key é—®é¢˜ä½¿å¾—é«˜ QPS ä¸‹ä¸å¾—ä¸é€€åŒ–æˆå•å®ä¾‹é™æµï¼‰</li><li>çƒ­ key é—®é¢˜ï¼šredis åˆ†ç‰‡ï¼Œkey å‰ç¼€å¢åŠ åˆ†ç‰‡å€¼ï¼Œå¯¹æ¯ä¸ªåˆ†ç‰‡å•ç‹¬è¿›è¡Œé™æµè®¡ç®—</li><li>å¹¶å‘ä¼˜åŒ–ï¼šå…è®¸æœ¬åœ° token è¶…å‘ï¼Œåç»­ä¸€æ¬¡æ€§å‘ redis ç”³æŠ¥</li><li>é¢„å‘ tokenï¼Œå±è”½æ— é™æµé£é™©çš„ redis ç”³æŠ¥</li></ul></li><li><p>Step æ­¥é•¿</p><ul><li>å¼•å…¥<code>step æ­¥é•¿</code>æ¦‚å¿µï¼Œé™æµæ¥å£çš„ä»¤ç‰Œæ•°é‡ä¾ç„¶åœ¨ redis ä¸­å­˜æ”¾ï¼Œä½†æ˜¯å–ä»¤ç‰Œæ•°é‡æ—¶ä¸åƒç²¾å‡†é™æµå™¨é‚£æ ·ä¸€æ¬¡å–ä¸€ä¸ªï¼Œè€Œæ˜¯ä»¥æ­¥é•¿ä¸ºå•ä½å»å–ï¼Œæ¯æ¬¡è·å–å•ä½æ­¥é•¿çš„ä»¤ç‰Œåˆ°æœ¬åœ°ç¼“å­˜ï¼Œæ–°çš„è¯·æ±‚è¿›å…¥éœ€è¦<strong>å…ˆå»æœ¬åœ°</strong>çš„ä»¤ç‰Œæ¡¶ä¸­è·å–ä»¤ç‰Œï¼Œå¦‚æœæœ¬åœ°ä»¤ç‰Œæ¡¶ä¸­æ¶ˆè€—å®Œä¹‹åéœ€è¦åˆ° redis æ¡¶ä¸­å†æ¬¡è·å–ç›´è‡³ redis æ¡¶ä¸­çš„ä»¤ç‰Œè¢«æ¶ˆè€—å®Œæ¯•ã€‚</li><li>Step = Min(QPS / 10k + 1, 10k)<ul><li>å• redis å®ä¾‹èƒ½å¤Ÿæ”¯æ’‘æœ€å¤§ 100k ç®€å•å‘½ä»¤ (<code>incr</code>)</li><li>100k QPS æ—¶ step ä¸ä¼šå¤ªå¤§è€Œé™ä½é™æµç²¾åº¦</li><li>100m QPS æ—¶ï¼Œå• key è®¿é—® redis çš„é¢‘ç‡èƒ½å¤Ÿé™åˆ¶åœ¨ 100k ä»¥å†…</li><li>10b QPS æš‚æ— æ³•æ”¯æŒ</li></ul></li></ul></li></ul><h3 id=é«˜-qps-é«˜ç²¾åº¦>é«˜ QPS é«˜ç²¾åº¦<a hidden class=anchor aria-hidden=true href=#é«˜-qps-é«˜ç²¾åº¦>#</a></h3><ul><li>æ‰“æ•£æ­¥é•¿ç­‰æ‰‹æ®µé™ä½ Redis è°ƒç”¨é‡ï¼Œé¿å…çƒ­ key é—®é¢˜</li></ul><h3 id=å¤§è§„æ¨¡é«˜-qps-ä½ç²¾åº¦-é›†ç¾¤é™æµ--å•å®ä¾‹é™æµ>å¤§è§„æ¨¡é«˜ QPS ä½ç²¾åº¦: é›†ç¾¤é™æµ / å•å®ä¾‹é™æµ<a hidden class=anchor aria-hidden=true href=#å¤§è§„æ¨¡é«˜-qps-ä½ç²¾åº¦-é›†ç¾¤é™æµ--å•å®ä¾‹é™æµ>#</a></h3><ul><li><p>ä¾èµ– Service Mesh</p></li><li><p>é›†ç¾¤é™æµï¼šä½¿ç”¨<strong>ä»¤ç‰Œæ¡¶</strong>ç®—æ³•ï¼Œæ¯éš” 1 ms å¡«å……ï¼Œä¿è¯æ—¶é—´çª—å£å†…å‘æ”¾çš„æ€» quota æ˜¯é™æµé˜ˆå€¼ï¼Œæœ€ç»ˆè½åœ¨å•ä¸ªå®ä¾‹ä¸Šåšé™æµ</p></li><li><p>å•å®ä¾‹é™æµï¼šå¯¹æ¯ä¸ªå®ä¾‹åšæœ¬åœ°é™æµé…ç½®ï¼ˆ<strong>ä»¤ç‰Œæ¡¶</strong>æˆ–<strong>æ»‘åŠ¨çª—å£</strong>ï¼‰</p></li></ul><h3 id=æ•æ„Ÿè€—æ—¶é™æµ>æ•æ„Ÿè€—æ—¶é™æµ<a hidden class=anchor aria-hidden=true href=#æ•æ„Ÿè€—æ—¶é™æµ>#</a></h3><ul><li><p>æ–¹å¼ä¸€ï¼šä½¿ç”¨å•å®ä¾‹é™æµ</p></li><li><p>æ–¹å¼äºŒï¼šçº¯å¼‚æ­¥åˆ†å¸ƒå¼é™æµï¼Œå­˜åœ¨ä¸€å®šç¨‹åº¦æ¼é™ç‡</p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.hypertars.com/tags/distributed-system/>Distributed System</a></li><li><a href=https://blog.hypertars.com/tags/distributed-rate-limiter/>Distributed Rate Limiter</a></li><li><a href=https://blog.hypertars.com/tags/redis/>Redis</a></li></ul><nav class=paginav><a class=prev href=https://blog.hypertars.com/posts/developer/distributed_systems/cache/><span class=title>Â« Prev Page</span><br><span>åˆ†å¸ƒå¼ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</span></a>
<a class=next href=https://blog.hypertars.com/posts/developer/distributed_systems/raft/><span class=title>Next Page Â»</span><br><span>Raft åˆ†å¸ƒå¼å…±è¯†ç®—æ³•</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share åˆ†å¸ƒå¼é™æµ on twitter" href="https://twitter.com/intent/tweet/?text=%e5%88%86%e5%b8%83%e5%bc%8f%e9%99%90%e6%b5%81&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2flimiter%2f&hashtags=DistributedSystem%2cDistributedRateLimiter%2cRedis"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share åˆ†å¸ƒå¼é™æµ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2flimiter%2f&title=%e5%88%86%e5%b8%83%e5%bc%8f%e9%99%90%e6%b5%81&summary=%e5%88%86%e5%b8%83%e5%bc%8f%e9%99%90%e6%b5%81&source=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2flimiter%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share åˆ†å¸ƒå¼é™æµ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2flimiter%2f&title=%e5%88%86%e5%b8%83%e5%bc%8f%e9%99%90%e6%b5%81"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share åˆ†å¸ƒå¼é™æµ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2flimiter%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share åˆ†å¸ƒå¼é™æµ on whatsapp" href="https://api.whatsapp.com/send?text=%e5%88%86%e5%b8%83%e5%bc%8f%e9%99%90%e6%b5%81%20-%20https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2flimiter%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share åˆ†å¸ƒå¼é™æµ on telegram" href="https://telegram.me/share/url?text=%e5%88%86%e5%b8%83%e5%bc%8f%e9%99%90%e6%b5%81&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2flimiter%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>