<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ZAB 原子广播协议 | HyperTars' Blog</title><meta name=keywords content="Distributed System,Consensus Algorithm,Zookeeper"><meta name=description content="Zookeeper Atomic Broadcast"><meta name=author content="HyperTars"><link rel=canonical href=https://blog.hypertars.com/posts/developer/distributed_systems/zab/><link crossorigin=anonymous href=/assets/css/stylesheet.min.f34b707e96a5011787260c43994ea6cd89c86f5fef677a5e3c78f655715fd662.css integrity="sha256-80twfpalAReHJgxDmU6mzYnIb1/vZ3pePHj2VXFf1mI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.hypertars.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.hypertars.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.hypertars.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.hypertars.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.hypertars.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="ZAB 原子广播协议"><meta property="og:description" content="Zookeeper Atomic Broadcast"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hypertars.com/posts/developer/distributed_systems/zab/"><meta property="og:image" content="https://blog.hypertars.com/posts/developer/distributed_systems/zab/https:/upload.wikimedia.org/wikipedia/commons/7/77/Apache_ZooKeeper_logo.svg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-02T10:41:32+08:00"><meta property="article:modified_time" content="2021-05-02T22:01:28+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.hypertars.com/posts/developer/distributed_systems/zab/https:/upload.wikimedia.org/wikipedia/commons/7/77/Apache_ZooKeeper_logo.svg"><meta name=twitter:title content="ZAB 原子广播协议"><meta name=twitter:description content="Zookeeper Atomic Broadcast"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Articles","item":"https://blog.hypertars.com/posts/"},{"@type":"ListItem","position":3,"name":"Developer","item":"https://blog.hypertars.com/posts/developer/"},{"@type":"ListItem","position":4,"name":"Distributed System","item":"https://blog.hypertars.com/posts/developer/distributed_systems/"},{"@type":"ListItem","position":5,"name":"ZAB 原子广播协议","item":"https://blog.hypertars.com/posts/developer/distributed_systems/zab/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ZAB 原子广播协议","name":"ZAB 原子广播协议","description":"Zookeeper Atomic Broadcast","keywords":["Distributed System","Consensus Algorithm","Zookeeper"],"articleBody":"1. Introduction 论文：\nhttps://marcoserafini.github.io/papers/zab.pdf Zookeeper 是一个分布式应用程序协调服务，提供数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、master 选举、分布式锁、分布式队列等功能。其实现得益于类文件系统的数据模型和基于 Watcher 机制的分布式事件通知，以及自身的高容错数据一致性协议。\nZooKeeper 的一致性实际是处于强一致性和顺序一致性之间。因为客户读链接 ZooKeeper 集群后，所有的写操作都必须发送给集群唯一的 leader，这个 leader 在内部同步块中赋予每个写操作一个顺序序列号（内部称为zxid，是单调增加的），上一个写操作不commit，下一个写操作就不执行，这一点实际上已经实现了写入的强一致性（线性化）了。\n但 ZooKeeper 的读操作是不做线性化的，否则读取一定拿到最新数据的话，过于影响性能了。客户端会缓存自己见到的最大的 zxid，如果与任何 server 建立 session 时发现，这个 server 最近更新的数据比自己还旧，那 server 端是会拒绝建立 session 的。也就是说，客户端侧在任何情况下都不会得到更老的数据，这又实现了顺序一致性。\n2. ZAB 协议 ZAB 协议是为分布式协调服务 ZK 专门设计的一种支持崩溃恢复的原子广播协议，其借鉴了 Paxos 算法。\nZK 基于该协议采用了主备模型 leader \u0026 follower，来保证集群中各个副本之间数据一致性。在主备系统架构模型中，只有 leader 负责处理外部的写事务请求，leader 将数据同步到其他 follower 节点，follower 只在本地处理读请求，如果是写请求则向 leader 提交事务，leader 接收到事务后广播该事务，只要超过半数节点写入成功，该事务就会被提交。\nZAB 协议特点\n集群在半数一下节点宕机时仍对外提供正常服务 客户端写请求全部转交 leader 处理，leader 确保写变更能实时同步给所有 follower 及 observer leader宕机或整个集群重启时，需要确保已经在 leader 服务器上提交的事务最终被所有服务器提交，确保丢弃只在 leader 服务器上被提出的事务，并保证集群快速恢复到故障前状态 ZAB 协议包括两种基本模式：崩溃恢复和消息广播\n当整个集群启动过程中，或者当 leader 服务器出现网络中断、崩溃退出或重启等异常时，ZAB 进入崩溃恢复模式，选举产生新 leader 当选举产生了新的 leader，同时集群中有过半的机器与该 leader 服务器完成了状态同步后，ZAB 退出崩溃恢复模式，进入消息广播模式。 2.1 ZAB 流程协议 ZAB 协议流程在论文中具有4步，而zookeeper在实现中将理论压缩为三个步骤\n选举和发现 数据同步 原子广播 2.1.1 选举和发现 集群节点的状态有以下几种\nLOOKING: ZK 集群处于崩溃恢复状态的时候，各个节点处于 LOOKING 状态 LEADING: ZK 集群处于消息广播状态的时候，leader 节点处于 LEADING 状态 FOLLOWING: ZK 集群处于消息广播状态的时候，follower 节点处于 FOLLOWING 状态 选举阶段集群间互相传递消息称为投票，投票 Vote 主要包括两个维度的信息：ID、ZXID\nServerID：被推举的 leader 的服务器 ID，集群中每个 ZK 节点启动前要配置好这个全局唯一的 ID ZXID：被推举的 leader 的事务 ID，该值从当前节点中选取的已经提交过的最大的事务 ID 选举\n在初始阶段，每个服务都会处于 LOOKING 状态互相通信寻找 leader，找不到会投自己一票，选票包含（机器 server id，最近一次 commit 提交的 zxid），发给其他机器。 每台机器以(zxid、机器 id)的优先级，比对自己的选票和收到的选票，更新选票信息后再次发出。（拥有最大 ZXID 的节点会赢得选举，若一致则比较最大 Server ID） 统计投票，超过 quorum 数量，则声明或选， leader、follower 角色确立。 发现\n这个阶段的主要目的在于 leader 得到存活 follower 内存中的事务。follower 连接到\"准 leader “，发送 ACKEPOCH，准 leader 收集 follower 发送的 zxid、sid，并且设定新的 epoch（原 epoch + 1），这样之前老的leader就无法再提交新的 proposals（提案）。 2.1.2 数据同步（数据恢复） leader向followers主动发起请求，这个阶段follower的数据要被同步为leader从上个阶段收集的数据。\nzookeeper leader存两个指标：\nminCommittedLog：leader内存中最小的提交日志 maxCommittedLog：leader数据库最大的提交日志 leader会结合指标根据每个learner数据状态发送不同的指令，可分为如下情况：\n回滚：learner数据比leader还新(\u003eminCommittedLog)，leader要求learner回滚到同自己相同的水平 差异同步：learner数据过时但\u003e=minCommittedLog，leader发送差异数据 回滚+差异同步：learner出现了上个epoch的数据（可能是上个朝代的leader） 快照全量同步：learner的数据比minCommittedLog小（非常古老了，必须用snapshot同步了） leader根据数据副本的不同的状态选择性的发送指令和数据，目的就是要让各个副本数据达成一致。 每个数据同步完毕的 learner 都会返回 ack 后，由 leader 将同步的 follower 加入到 forwardingFollowers 队列（hashSet）中，也就是说leader 维护了每个 learner 的 deadline time、socket对象、对应的阻塞队列（每个 learner 都有一个）等。\n不管 leader 还是 follower，启动都要经过以上阶段。同时节点任何步骤出现失败或超时，节点都会回退到选举阶段。\n2.1.3 原子广播 随着新的follower不断加入并同步好数据，leader判断可用节点达到quorum(一般是集群节点数量的一半加一)时，客户端发起的写入请求才会被这些参与同步的leader、learner接收*。\n原子广播类似两阶段提交，但是可以不收到全部 follower 反馈，只需要半数以上（避免严重阻塞）\n节点 A 接到任何客户端写入请求都要转发到 leader leader 生成 zxid，封装请求为 proposal 发给所有 followers 的 FIFO 队列（每个 follower 都有一个 FIFO 队列） follower 接到后 proposal，先写 transactionlog 事务日志到磁盘，然后回复 leader ack（3.7.0版本此处新增了异步发送特性）。 leader 接到半数以上 ack 后认为消息发送成功，再向所有 follower 发 commit、所有 observer 发 proposal，同时自身完成事务提交。leader先判断上个zxid是否还存在，只有不存在才继续，之后再判断是否达到半数以上 ack，判断半数以上 ack 有两种实现，一种是分组得分制（QuorumHierarchical）、一种是 ack 计数制。 follower 接到并执行 commit 后回复 leader ack，这里有一点，如果提交的 zxid 不是 follower 最近 pending 的那个（存储于 pendingTxns），也就是可能网络丢包或绕路了，那 follower 直接退出。 节点A执行后，向客户端返回 response 2.2 ZAB 故障检测（心跳机制） 发现、同步和广播阶段都没有考虑节点宕机的问题，为了检测失败，Zab 提供 followers 和 leader间的周期性心跳\n如果 leader 在一段时间内没有收到 quorum 数量的心跳，它则放弃领导权并进入选举。 如果 follower 在一段时间没有接到 leader 的心跳，会进入选举状态。 也就是说，维持主从关心的心跳。是由 leader 主动 ping 的 当 follower 处理的时候，是直接返回的。\nleader 对于 ping 包的构造，主要就是会携带最近发起过 proposal 的 txid，其他不带有任何数据。\n同时这两种情况都会使集群进入恢复模式。\n2.3 ZAB 崩溃恢复 在zab协议的第一个阶段（选举和发现）中，内含了崩溃恢复的机制，恢复阶段从 ZAB 协议的\"同步\"阶段中集成了很多内容。\n崩溃恢复的意义就是追求数据一致性，它保证：\nleader 发出过 commit 的消息，最终会被所有节点 commit leader 没 commit 的消息会被丢弃 2.4 ZAB 提交提案 原子广播 2PC 中，第一步 leader 会发送 proposal 到 follower，半数节点以上 ack 才进行 commit，如果没有半数节点 ack呢？或者半数以上节点拒绝了呢？传统数据库 2PC 会进行回滚，ZooKeeper 的话，leade r会下台，如果选举后新的 leader 内存中存在这个未 commit 的 proposal，才会再次尝试提交。\n如果 follower 没有接到 COMMIT，有三个机制保证数据最终一致：\n下次事务请求时，leader 会向待同步节点发送 SYNC 命令 follower 接到一个新包发现跳包了，自行推出，后面重连到集群 如果真的发生网络分区了，leader 会将这个长久不联系的节点从可用节点剔除 3 ZAB 存在的问题 客户端看到的不一致 以为在广播 commit 阶段，leader 和 follower 之间有网络延迟，到达 follower 时先后时间点不一致，注定了有些 follower 比其他更快的读取到最新的数据 一个 client 两个连接，造成的消息不守序 在一个 client 端建立一条跟 ZK 的连接时，消息按严格有序的方式投递到 leader，并严格的顺序被广播给 follower。但是如果一个客户端机器建立两个连接时，发送给两个连接的消息是不能保序的。 重复消息投递的可能性 如果一个 proposal 在 leader 宕机前没有被 commit，而且接收到 proposal 的 follower 也不确定是哪几台，那么新的 leader 选举时，包含新 proposal 日志的 server 不一定参与集群选举，如果参与的话，该日志会最终被 zk 集群 commit，如果没参与，那该事务就丢失了。虽然两种情况 client 端确定本次请求失败，但是前者在 server 确实被记录了，如果 client 认为失败而补发，那请求会被重复投递。 ","wordCount":"3527","inLanguage":"en","image":"https://blog.hypertars.com/posts/developer/distributed_systems/zab/https:/upload.wikimedia.org/wikipedia/commons/7/77/Apache_ZooKeeper_logo.svg","datePublished":"2021-05-02T10:41:32+08:00","dateModified":"2021-05-02T22:01:28+08:00","author":[{"@type":"Person","name":"HyperTars"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hypertars.com/posts/developer/distributed_systems/zab/"},"publisher":{"@type":"Organization","name":"HyperTars' Blog","logo":{"@type":"ImageObject","url":"https://blog.hypertars.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://blog.hypertars.com accesskey=h title="HyperTars' Blog (Alt + H)">HyperTars' Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://hypertars.com title=🏠Home><span>🏠Home</span></a></li><li><a href=https://blog.hypertars.com/search/ title="🔍Search (Alt + /)" accesskey=/><span>🔍Search</span></a></li><li><a href=https://blog.hypertars.com/posts/developer/ title=👨🏻‍💻Developer><span>👨🏻‍💻Developer</span></a></li><li><a href=https://blog.hypertars.com/archives/ title=⏱Archives><span>⏱Archives</span></a></li><li><a href=https://blog.hypertars.com/tags/ title=🔖tags><span>🔖tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.hypertars.com>Home</a>&nbsp;»&nbsp;<a href=https://blog.hypertars.com/posts/>Articles</a>&nbsp;»&nbsp;<a href=https://blog.hypertars.com/posts/developer/>Developer</a>&nbsp;»&nbsp;<a href=https://blog.hypertars.com/posts/developer/distributed_systems/>Distributed System</a></div><h1 class=post-title>ZAB 原子广播协议</h1><div class=post-description>Zookeeper Atomic Broadcast</div><div class=post-meta><span title='2021-05-02 10:41:32 +0800 +0800'>2021-05-02</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;HyperTars</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-introduction aria-label="1. Introduction">1. Introduction</a></li><li><a href=#2-zab-%e5%8d%8f%e8%ae%ae aria-label="2. ZAB 协议">2. ZAB 协议</a><ul><li><a href=#21-zab-%e6%b5%81%e7%a8%8b%e5%8d%8f%e8%ae%ae aria-label="2.1 ZAB 流程协议">2.1 ZAB 流程协议</a><ul><li><a href=#211-%e9%80%89%e4%b8%be%e5%92%8c%e5%8f%91%e7%8e%b0 aria-label="2.1.1 选举和发现">2.1.1 选举和发现</a></li><li><a href=#212-%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5%e6%95%b0%e6%8d%ae%e6%81%a2%e5%a4%8d aria-label="2.1.2 数据同步（数据恢复）">2.1.2 数据同步（数据恢复）</a></li><li><a href=#213-%e5%8e%9f%e5%ad%90%e5%b9%bf%e6%92%ad aria-label="2.1.3 原子广播">2.1.3 原子广播</a></li></ul></li><li><a href=#22-zab-%e6%95%85%e9%9a%9c%e6%a3%80%e6%b5%8b%e5%bf%83%e8%b7%b3%e6%9c%ba%e5%88%b6 aria-label="2.2 ZAB 故障检测（心跳机制）">2.2 ZAB 故障检测（心跳机制）</a></li><li><a href=#23-zab-%e5%b4%a9%e6%ba%83%e6%81%a2%e5%a4%8d aria-label="2.3 ZAB 崩溃恢复">2.3 ZAB 崩溃恢复</a></li><li><a href=#24-zab-%e6%8f%90%e4%ba%a4%e6%8f%90%e6%a1%88 aria-label="2.4 ZAB 提交提案">2.4 ZAB 提交提案</a></li></ul></li><li><a href=#3-zab-%e5%ad%98%e5%9c%a8%e7%9a%84%e9%97%ae%e9%a2%98 aria-label="3 ZAB 存在的问题">3 ZAB 存在的问题</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener('DOMContentLoaded',function(){checkTocPosition(),elements=document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]'),activeElement=elements[0];const e=encodeURI(activeElement.getAttribute('id')).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add('active')},!1),window.addEventListener('resize',function(){checkTocPosition()},!1),window.addEventListener('scroll',()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute('id')).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add('active'):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove('active')})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue('--gap'),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=1-introduction>1. Introduction<a hidden class=anchor aria-hidden=true href=#1-introduction>#</a></h2><p>论文：</p><ul><li><a href=https://marcoserafini.github.io/papers/zab.pdf>https://marcoserafini.github.io/papers/zab.pdf</a></li></ul><p>Zookeeper 是一个分布式应用程序协调服务，提供数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、master 选举、分布式锁、分布式队列等功能。其实现得益于类文件系统的数据模型和基于 Watcher 机制的分布式事件通知，以及自身的高容错数据一致性协议。</p><p>ZooKeeper 的一致性实际是处于强一致性和顺序一致性之间。因为客户读链接 ZooKeeper 集群后，所有的写操作都必须发送给集群唯一的 leader，这个 leader 在内部同步块中赋予每个写操作一个顺序序列号（内部称为zxid，是单调增加的），上一个写操作不commit，下一个写操作就不执行，这一点实际上已经实现了写入的强一致性（线性化）了。</p><p>但 ZooKeeper 的读操作是不做线性化的，否则读取一定拿到最新数据的话，过于影响性能了。客户端会缓存自己见到的最大的 zxid，如果与任何 server 建立 session 时发现，这个 server 最近更新的数据比自己还旧，那 server 端是会拒绝建立 session 的。也就是说，客户端侧在任何情况下都不会得到更老的数据，这又实现了顺序一致性。</p><h2 id=2-zab-协议>2. ZAB 协议<a hidden class=anchor aria-hidden=true href=#2-zab-协议>#</a></h2><p>ZAB 协议是为分布式协调服务 ZK 专门设计的一种<strong>支持崩溃恢复</strong>的原子广播协议，其借鉴了 Paxos 算法。</p><p>ZK 基于该协议采用了主备模型 leader & follower，来保证集群中各个副本之间数据一致性。在主备系统架构模型中，只有 leader 负责处理外部的写事务请求，leader 将数据同步到其他 follower 节点，follower 只在本地处理读请求，如果是写请求则向 leader 提交事务，leader 接收到事务后广播该事务，只要超过半数节点写入成功，该事务就会被提交。</p><p>ZAB 协议特点</p><ol><li>集群在半数一下节点宕机时仍对外提供正常服务</li><li>客户端写请求全部转交 leader 处理，leader 确保写变更能实时同步给所有 follower 及 observer</li><li>leader宕机或整个集群重启时，需要确保已经在 leader 服务器上提交的事务最终被所有服务器提交，确保丢弃只在 leader 服务器上被提出的事务，并保证集群快速恢复到故障前状态</li></ol><p>ZAB 协议包括两种基本模式：崩溃恢复和消息广播</p><ul><li>当整个集群启动过程中，或者当 leader 服务器出现网络中断、崩溃退出或重启等异常时，ZAB 进入崩溃恢复模式，选举产生新 leader</li><li>当选举产生了新的 leader，同时集群中有过半的机器与该 leader 服务器完成了状态同步后，ZAB 退出崩溃恢复模式，进入消息广播模式。</li></ul><h3 id=21-zab-流程协议>2.1 ZAB 流程协议<a hidden class=anchor aria-hidden=true href=#21-zab-流程协议>#</a></h3><p>ZAB 协议流程在论文中具有4步，而zookeeper在实现中将理论压缩为三个步骤</p><ul><li>选举和发现</li><li>数据同步</li><li>原子广播</li></ul><h4 id=211-选举和发现>2.1.1 选举和发现<a hidden class=anchor aria-hidden=true href=#211-选举和发现>#</a></h4><p>集群节点的状态有以下几种</p><ul><li>LOOKING: ZK 集群处于崩溃恢复状态的时候，各个节点处于 LOOKING 状态</li><li>LEADING: ZK 集群处于消息广播状态的时候，leader 节点处于 LEADING 状态</li><li>FOLLOWING: ZK 集群处于消息广播状态的时候，follower 节点处于 FOLLOWING 状态</li></ul><p>选举阶段集群间互相传递消息称为投票，投票 Vote 主要包括两个维度的信息：ID、ZXID</p><ul><li>ServerID：被推举的 leader 的服务器 ID，集群中每个 ZK 节点启动前要配置好这个全局唯一的 ID</li><li>ZXID：被推举的 leader 的事务 ID，该值从当前节点中选取的已经提交过的最大的事务 ID</li></ul><p>选举</p><ul><li>在初始阶段，每个服务都会处于 LOOKING 状态互相通信寻找 leader，找不到会投自己一票，选票包含（机器 server id，最近一次 commit 提交的 zxid），发给其他机器。</li><li>每台机器以(zxid、机器 id)的优先级，比对自己的选票和收到的选票，更新选票信息后再次发出。（拥有最大 ZXID 的节点会赢得选举，若一致则比较最大 Server ID）</li><li>统计投票，超过 quorum 数量，则声明或选， leader、follower 角色确立。</li></ul><p>发现</p><ul><li>这个阶段的主要目的在于 leader 得到存活 follower 内存中的事务。<strong>follower 连接到"准 leader &ldquo;</strong>，发送 ACKEPOCH，准 leader 收集 follower 发送的 zxid、sid，并且设定新的 epoch（原 epoch + 1），这样之前老的leader就无法再提交新的 proposals（提案）。</li></ul><h4 id=212-数据同步数据恢复>2.1.2 数据同步（数据恢复）<a hidden class=anchor aria-hidden=true href=#212-数据同步数据恢复>#</a></h4><p>leader向followers主动发起请求，这个阶段follower的数据要被同步为leader从上个阶段收集的数据。</p><p>zookeeper leader存两个指标：</p><ul><li>minCommittedLog：leader内存中最小的提交日志</li><li>maxCommittedLog：leader数据库最大的提交日志</li></ul><p>leader会结合指标根据每个learner数据状态发送不同的指令，可分为如下情况：</p><ul><li>回滚：learner数据比leader还新(>minCommittedLog)，leader要求learner回滚到同自己相同的水平</li><li>差异同步：learner数据过时但>=minCommittedLog，leader发送差异数据</li><li>回滚+差异同步：learner出现了上个epoch的数据（可能是上个朝代的leader）</li><li>快照全量同步：learner的数据比minCommittedLog小（非常古老了，必须用snapshot同步了）</li></ul><p><strong>leader根据数据副本的不同的状态选择性的发送指令和数据，目的就是要让各个副本数据达成一致</strong>。 每个数据同步完毕的 learner 都会返回 ack 后，由 leader 将同步的 follower 加入到 forwardingFollowers 队列（hashSet）中，也就是说leader 维护了每个 learner 的 deadline time、socket对象、对应的阻塞队列（每个 learner 都有一个）等。</p><p>不管 leader 还是 follower，启动都要经过以上阶段。同时节点任何步骤出现失败或超时，节点都会回退到选举阶段。</p><h4 id=213-原子广播>2.1.3 原子广播<a hidden class=anchor aria-hidden=true href=#213-原子广播>#</a></h4><p>随着新的follower不断加入并同步好数据，leader判断可用节点达到quorum(一般是集群节点数量的一半加一)时，客户端发起的写入请求才会被这些参与同步的leader、learner接收*。</p><p>原子广播<strong>类似两阶段提交</strong>，但是可以不收到全部 follower 反馈，只需要半数以上（避免严重阻塞）</p><ol><li>节点 A 接到任何客户端写入请求都要转发到 leader</li><li>leader 生成 zxid，封装请求为 proposal 发给所有 followers 的 FIFO 队列（每个 follower 都有一个 FIFO 队列）</li><li>follower 接到后 proposal，先写 transactionlog 事务日志到磁盘，然后回复 leader ack（3.7.0版本此处新增了异步发送特性）。</li><li>leader 接到半数以上 ack 后认为消息发送成功，再向所有 follower 发 commit、所有 observer 发 proposal，同时自身完成事务提交。<strong>leader先判断上个zxid是否还存在，只有不存在才继续</strong>，之后再判断是否达到半数以上 ack，判断半数以上 ack 有两种实现，一种是分组得分制（QuorumHierarchical）、一种是 ack 计数制。</li><li>follower 接到并执行 commit 后回复 leader ack，这里有一点，如果提交的 zxid 不是 follower 最近 pending 的那个（存储于 pendingTxns），也就是可能网络丢包或绕路了，那 <strong>follower 直接退出</strong>。</li><li>节点A执行后，向客户端返回 response</li></ol><h3 id=22-zab-故障检测心跳机制>2.2 ZAB 故障检测（心跳机制）<a hidden class=anchor aria-hidden=true href=#22-zab-故障检测心跳机制>#</a></h3><p>发现、同步和广播阶段都没有考虑节点宕机的问题，为了检测失败，Zab 提供 followers 和 leader间的周期性心跳</p><p>如果 leader 在一段时间内没有收到 quorum 数量的心跳，它则放弃领导权并进入选举。
如果 follower 在一段时间没有接到 leader 的心跳，会进入选举状态。
也就是说，维持主从关心的心跳。是由 leader 主动 ping 的
当 follower 处理的时候，是直接返回的。</p><p>leader 对于 ping 包的构造，主要就是会携带最近发起过 proposal 的 txid，其他不带有任何数据。</p><p>同时这两种情况都会使集群进入恢复模式。</p><h3 id=23-zab-崩溃恢复>2.3 ZAB 崩溃恢复<a hidden class=anchor aria-hidden=true href=#23-zab-崩溃恢复>#</a></h3><p>在zab协议的第一个阶段（选举和发现）中，内含了崩溃恢复的机制，恢复阶段从 ZAB 协议的"同步"阶段中集成了很多内容。</p><p>崩溃恢复的意义就是追求数据一致性，它保证：</p><ul><li>leader 发出过 commit 的消息，最终会被所有节点 commit</li><li>leader 没 commit 的消息会被丢弃</li></ul><h3 id=24-zab-提交提案>2.4 ZAB 提交提案<a hidden class=anchor aria-hidden=true href=#24-zab-提交提案>#</a></h3><p>原子广播 2PC 中，第一步 leader 会发送 proposal 到 follower，半数节点以上 ack 才进行 commit，如果没有半数节点 ack呢？或者半数以上节点拒绝了呢？传统数据库 2PC 会进行回滚，ZooKeeper 的话，leade r会下台，如果选举后新的 leader 内存中存在这个未 commit 的 proposal，才会再次尝试提交。</p><p>如果 follower 没有接到 COMMIT，有三个机制保证数据最终一致：</p><ul><li>下次事务请求时，leader 会向待同步节点发送 SYNC 命令</li><li>follower 接到一个新包发现跳包了，自行推出，后面重连到集群</li><li>如果真的发生网络分区了，leader 会将这个长久不联系的节点从可用节点剔除</li></ul><h2 id=3-zab-存在的问题>3 ZAB 存在的问题<a hidden class=anchor aria-hidden=true href=#3-zab-存在的问题>#</a></h2><ol><li>客户端看到的不一致</li></ol><ul><li>以为在广播 commit 阶段，leader 和 follower 之间有网络延迟，到达 follower 时先后时间点不一致，注定了有些 follower 比其他更快的读取到最新的数据</li></ul><ol start=2><li>一个 client 两个连接，造成的消息不守序</li></ol><ul><li>在一个 client 端建立一条跟 ZK 的连接时，消息按严格有序的方式投递到 leader，并严格的顺序被广播给 follower。但是如果一个客户端机器建立两个连接时，发送给两个连接的消息是不能保序的。</li></ul><ol start=3><li>重复消息投递的可能性</li></ol><ul><li>如果一个 proposal 在 leader 宕机前没有被 commit，而且接收到 proposal 的 follower 也不确定是哪几台，那么新的 leader 选举时，包含新 proposal 日志的 server 不一定参与集群选举，如果参与的话，该日志会最终被 zk 集群 commit，如果没参与，那该事务就丢失了。虽然两种情况 client 端确定本次请求失败，但是前者在 server 确实被记录了，如果 client 认为失败而补发，那请求会被重复投递。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.hypertars.com/tags/distributed-system/>Distributed System</a></li><li><a href=https://blog.hypertars.com/tags/consensus-algorithm/>Consensus Algorithm</a></li><li><a href=https://blog.hypertars.com/tags/zookeeper/>Zookeeper</a></li></ul><nav class=paginav><a class=prev href=https://blog.hypertars.com/posts/developer/distributed_systems/raft/><span class=title>« Prev Page</span><br><span>Raft 分布式共识算法</span></a>
<a class=next href=https://blog.hypertars.com/posts/developer/distributed_systems/transaction/><span class=title>Next Page »</span><br><span>分布式事务</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share ZAB 原子广播协议 on twitter" href="https://twitter.com/intent/tweet/?text=ZAB%20%e5%8e%9f%e5%ad%90%e5%b9%bf%e6%92%ad%e5%8d%8f%e8%ae%ae&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2fzab%2f&hashtags=DistributedSystem%2cConsensusAlgorithm%2cZookeeper"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ZAB 原子广播协议 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2fzab%2f&title=ZAB%20%e5%8e%9f%e5%ad%90%e5%b9%bf%e6%92%ad%e5%8d%8f%e8%ae%ae&summary=ZAB%20%e5%8e%9f%e5%ad%90%e5%b9%bf%e6%92%ad%e5%8d%8f%e8%ae%ae&source=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2fzab%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ZAB 原子广播协议 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2fzab%2f&title=ZAB%20%e5%8e%9f%e5%ad%90%e5%b9%bf%e6%92%ad%e5%8d%8f%e8%ae%ae"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ZAB 原子广播协议 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2fzab%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ZAB 原子广播协议 on whatsapp" href="https://api.whatsapp.com/send?text=ZAB%20%e5%8e%9f%e5%ad%90%e5%b9%bf%e6%92%ad%e5%8d%8f%e8%ae%ae%20-%20https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2fzab%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ZAB 原子广播协议 on telegram" href="https://telegram.me/share/url?text=ZAB%20%e5%8e%9f%e5%ad%90%e5%b9%bf%e6%92%ad%e5%8d%8f%e8%ae%ae&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdistributed_systems%2fzab%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>