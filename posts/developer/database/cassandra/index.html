<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Apache Cassandra | HyperTars' Blog</title><meta name=keywords content="Database,NoSQL"><meta name=description content="A NoSQL Database"><meta name=author content="HyperTars"><link rel=canonical href=https://blog.hypertars.com/posts/developer/database/cassandra/><link crossorigin=anonymous href=/assets/css/stylesheet.min.f34b707e96a5011787260c43994ea6cd89c86f5fef677a5e3c78f655715fd662.css integrity="sha256-80twfpalAReHJgxDmU6mzYnIb1/vZ3pePHj2VXFf1mI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.hypertars.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.hypertars.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.hypertars.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.hypertars.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.hypertars.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Apache Cassandra"><meta property="og:description" content="A NoSQL Database"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hypertars.com/posts/developer/database/cassandra/"><meta property="og:image" content="https://blog.hypertars.com/posts/developer/database/cassandra/https:/upload.wikimedia.org/wikipedia/commons/5/5e/Cassandra_logo.svg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-08T00:00:00+08:00"><meta property="article:modified_time" content="2021-05-08T00:00:00+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.hypertars.com/posts/developer/database/cassandra/https:/upload.wikimedia.org/wikipedia/commons/5/5e/Cassandra_logo.svg"><meta name=twitter:title content="Apache Cassandra"><meta name=twitter:description content="A NoSQL Database"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Articles","item":"https://blog.hypertars.com/posts/"},{"@type":"ListItem","position":3,"name":"Developer","item":"https://blog.hypertars.com/posts/developer/"},{"@type":"ListItem","position":4,"name":"Database","item":"https://blog.hypertars.com/posts/developer/database/"},{"@type":"ListItem","position":5,"name":"Apache Cassandra","item":"https://blog.hypertars.com/posts/developer/database/cassandra/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Apache Cassandra","name":"Apache Cassandra","description":"A NoSQL Database","keywords":["Database","NoSQL"],"articleBody":"存储方式 宽列存储 / 列簇存储\n实现 DynamoDB - 副本复制模型、无单点失效架构 BigTable - 数据和存储引擎模型\n   Category Dynamo BigTable     Arch Decentralized Centralized   Data Model Key-Value Column-Oriented   API Get, Put Get, Put, Scan, Delete   Security No Access control at column-family level   Partitioning Consistent Hashing Key range based   Replication Across data centers No, Within a single data center in GFS   Storage Plug-in SSTables in GFS   Read/Write Quorum-like Reads - merge of SSTables and memtable, Writes-tablet log and memtable   Concurrency Control Vector clocks with reconciliation during reads Copy-On-Write   Membership and failure detection Gossip-based protocol Handshakes initiated by master   CAP AP CP    特点  完整的多主数据库复制 高可用, 容错 弹性可扩展 分区的面相键查询 可调节的一致性 AP or CP 无 Schema 写性能高  数据模型 1 2 3 4 5 6  Keyspace: ${KeyspaceName}  ColumnFamily: ${ColumnFamilyName}  Key: ${Key1, Key2, ...}  Columns: {Columns}  ${ColumnName}  ${Data}   Keyspace  每个 Keyspace 包含一个或多个 Table, 一般一个集群只需要一个 KeySpace 属性  副本因子 Replication Factor 是每行数据会复制到多少个节点上。副本因子的选择决定了要为一致性付出多少代价, 所得到的读写的一致性水平取决于副本因子的设定。 副本放置策略    Table  与 ColumnFamily 为相同概念, 类似于关系型数据库里的表。是容纳一个有序的行集合的容器。每一行又是有序的列的集合。向 Cassandra 读写数据时, 可以为一列或多列指定值, 至少包含一个主键值。  1 2 3 4 5 6 7 8  cassandra getHotelier.Hotel['NYN_042'] =(column=zip, value=10019, timestamp=3894166157031651) =(column=state, value=NY, timestamp=3894166157031651) =(column=phone, value=2125555555, timestamp=3894166157031651) =(column=name, value=TheWaldorf=Astoria, timestamp=3894166157031651) =(column=city, value=NewYork, timestamp=3894166157031651) =(column=address, value=301ParkAve, timestamp=3894166157031651) Returned 6 results.   Column   列是由名称、值和时间戳组成的三元组。相当于表中的一个携带时间戳的单元格。Cassandra 之中不需要预先定义列, 只需要在 keyspace 里定义表就可以写数据了, 所有列的名字都是客户端提供的。使 Cassandra 看起来像四维 Hash: [Keyspace][Table][Key][Column]\n  特性\n 同一表的行在磁盘上存储在一起 Cassandra 不支持 Join 同一表中, 列是可以根据列名排序的 (一般是字典序, 用于高效地从很宽的行里高效取出一列而无需把每列都读入内存) 除了写入时间外, 还额外存储了 TTL (TTL 是 Column 粒度的)    二级索引\n Cassandra允许对列建二级索引, 由于Cassandra将数据划分到多个节点上, 每个节点必须根据存储在相应分区上的数据维护自己的二级索引, 因此二级索引的查询通常涉及多个节点, 导致查询开销显著增加。通常为读性能考虑更倾向于物化视图 (写开销大)。    架构 存储结构 1 2 3 4 5 6 7  Write  - CommitLog  - Memtable  - SSTable  - SSTable  - SSTable  - ...    CommitLog - Memtable - SSTable  进行写操作的时候, 数据是直接写入到 commitlog 中的。写操作只有写入到 commitlog 才被认为是成功的, 这样, 即使数据还没有进入内存 memtable 中, 也可以进行数据恢复。 数据写入到 commitlog 中之后, 同时写入内存中名为 memtable 的数据结构之中。当memtable 之中存储的对象数量达到阈值(或者容量达到阈值, 或者达到某时间间隔)之后, memtable 会被刷入磁盘 SSTable 文件中。然后, 创建一个新的 memtable, 接收数据。这个过程是个非阻塞操作, 对于一个表, 可以有多个 memtable, 一个是当前的, 其他的则是等待写入磁盘的。这个过程通常不会很长, 除非节点过载了, 否则刷写的过程应该会很快。 SSTable 的概念是从 Google 的 Bigtable 里借鉴过来的。一旦 memtable 被刷写入磁盘, 成为一个 SSTable, 它就是不可变的了。SSTable 可以合并, 合并是进行了归并排序的“归并”步骤, 将数据并入新的文件, 并删除旧文件。 所有的写操作是顺序进行的, 这是 Cassandra 的写操作性能出众的主要原因。在 Cassandra 之中, 所有的写都是 append 操作, 没有任何读或查找操作。合并操作定期地重新组织数据, 不过合并操作同样也是进行顺序读写。合并操作可以获得更好的读性能。    缓存  Key 缓存: Key - 行索引的映射 (Key1 - DataPosition1, Key2 - DataPosition2), 存在 JVM 堆上, 默认打开 行缓存: 缓存所有的行, 存在堆外内存, 默认禁用  墓碑  所有的删除操作都转化为更新操作, 在值上放置墓碑, 在合并阶段才真正删除  Bloom Filter 分布式架构  单个 Data Center 使用一致性哈希环的架构 通过 murmur3 算法给 Key 计算 64 位 Hash 值, 去落到不同的节点上。Cassandra 默认支持虚拟节点, 为每个节点分配 256 个令牌。 副本默认策略是放置在环中接下来的 N 个节点中  Gossip  为了做到无中心、容忍网络分裂, Cassandra 使用了一个 gossip 协议来进行环内通信, 这样每个节点都会有其他节点的状态信息。 Gossiper 在定时器的控制下, 每秒钟运行一次。提示移交 (hinted-handoff) 是由 gossip 触发的。当一个节点发现另一个节点重新在线, 而它正好有关于这个节点的提示信息时, 就会触发提示移交。 Gosspier 周期性的运行, 在环里随机选择一个节点, 发起对这个节点的 gossip 回话。每轮 gossip 需要三条消息。不仅交换自身信息, 还交换通过之前的 gossip 通信了解的其他节点信息。所以所有的节点能够很快的了解集群中的其他节点情况。  Gossip 的发起者给它选好的伙伴节点发送一条 GossipDigestSyncMessage 当伙伴节点收到消息时, 回复一条 GossipDigestAckMessage 发起者收到伙伴发回的响应消息后, 再向伙伴发送一条 GossipDigestAck2Message, 以此完成本轮 gossip   相比于一个固定的阈值来标记一个节点为 fail, Cassandra 采用一个自然增长的检测机制来计算每个节点的阈值, 考虑到了网络、负载、历史状况等因素。当进行 gossip 交换时, 每个节点维护了一个其他节点 gossip 信息到达滑动窗口时间。可以通过配置 phi_convict_threshold 属性来调节失败检测的敏感性。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  public class GossipDigest implements Comparable {  final InetAddressAndPort endpoint;  final int generation; // generation stays the same when server is running and grows every time the node is started  final int maxVersion; } public class GossipDigestSyn {  final String clusterId;  final String partioner;  final List gDigests; } public class GossipDigestAck {  final List gDigestList;  final MapepStateMap; } public class GossipDigestAck2 {  final MapepStateMap; }   hinted handoff  一个写请求到达 Cassandra，但是负责这部分数据的节点却由于网络分裂、硬件故障或其他原因而不可用。为了保证整个环在这种情况下的可用性，Cassandra 实现了一个称为提示移交（hintedhandoff）的机制。 可以把一个提示看做是一个小即时贴，上面记录着写请求的内容。如果写操作所属的节点失败了，Cassandra 接收到该请求的节点会创建一个提示，包含这样一条备忘信息：“我有一个给节点B的写请求信息。这个请求现在挂起了，等到节点B回来的时候请告知我，那时我会把写请求送交给它。”也就是说，写操作的提示信息将会从节点A移交给节点B。  一致性等级   因为Cassandra中的读写操作可以分别指定一致性级别，所以Cassandra的一致性被认为是可调的。\n  ZERO (deprecated): 在写数据被记录之前就返回；写操作将会在一个后台线程中异步完成，无法确保写操作一定成功\n  ANY: 集群中任意一台服务器响应（包括HINT）即成功\n  ONE, TWO, THREE: 集群中任意1/2/3台服务器响应（不包括HINT，即写commitlog成功）即成功\n  QUORUM (Most Freq): 集群中响应（不包括HINT）的服务器数量=ReplicationFactor/2+1即成功。平衡一致性和高可用性的方案。\n  LOCAL_QUORUM: 在QUORUM基础上，要求写入成功的节点至少有一台与接受写入操作的服务器属同一DC\n  EACH_QUORUM: 在QUORUM基础上，要求写入成功的节点至少有一台与接受写入操作的服务器不属同一DC\n  ALL: 集群中响应写入成功的服务器数量等于 ReplicationFactor 即成功\n  不论是读操作还是写操作, ZERO, ANY, ONE 都被划分为弱一致性, 而 QUORUM 和 ALL 则属于强一致性。在 Cassandra 中, 要达到强一致性, 可以使用如下这个流行的公式: R + W  N = Strong Consistency。R: Read Replica, W: Write Replica, N: Replication Factor。这时, 所有客户端都可以得到最新的写入结果, 即可以得到强一致性。\n  写操作  如果集群跨多个 DC, 本地协调器节点会在其他各个数据中心分别选择一个远程协调器, 每个远程副本直接响应原协调器节点。 一旦有满足一致性级别要求的副本作出响应, 则协调器向客户端确认这个写操作。  读操作  协调器会把请求发给认为最近的 (snich 策略) 一个副本读完整数据本地计算摘要, 从其他副本直接请求摘要, 如果一致且满足一致性要求, 则返回数据。如果摘要不一致, 协调器回完成修复。  事务  Cassandra 支持轻量级事务, 基于 Paxos 共识算法实现  基本 Paxos 算法包含两个阶段:  准备 / 承诺 提议 / 接受。   要修改数据, 会有一个协调器节点担任领导者的角色, 向其他副本节点提出一个新值。其他节点同时担任其他修改的领导者。每个副本节点会检查提议, 如果这个提议看到的是最新提议, 它会承诺不接受之前任何提议关联的提议。每个副本节点会返回它接受的最新提议。如果这个提议被大多数副本接受, 领导者就会提交这个提议, 但需要注意的是, 必须先提交这个提议之前的所有在处理的提议。 Cassandra 实现扩展了基本 Paxos 算法来支持所需的 写前读 语义, 也称为 检查-设置, 并允许在事务之间重置状态。为此, 它在算法中插入了额外的两个阶段, 现在的工作如下:  准备 / 承诺 读 / 结果 提议 / 接受 提交 / 确认   Cassandra 会为每个分区存储一个 Paxos 状态, 可以保证不同分区的事务不会互相打扰。    总结 适用场景  大规模部署: 分布式架构 写密集、统计和分析型: 有高可用性, 有写吞吐量优化 多数据中心结构: 有针对多 DC 设计和相关配置     Category Cassandra     CAP AP or CP   通信 Gossip   oltp/olap 偏重oltp   API 支持SQL语法(通过二级索引)   路由 Snitch算法   语言 Java   设计参考 BigTable and Dynamo   License Apache   Protocol CQL, binary (Thrift)   数据分布 水平扩展：改进的一致性哈希（虚拟节点）   存储目标 小文件   一致性 可选，一般选最终一致性，Quorum策略   架构 p2p   高可用性 P2P和去中心化设计，不会出现单点故障   伸缩性 扩容需在Hash Ring上多个节点间调整数据分布   读写性能 数据读写定位非常快   数据冲突处理 向量时钟   临时故障处理 数据回传机制：某节点宕机，hash到该节点的新数据自动路由到下一节点做 hinted handoff，源节点恢复后，推送回源节点。   永久故障恢复 Merkle 哈希树，通过Gossip协议同步Merkle Tree，维护集群节点间的数据一致性   成员通信及错误检测 基于Gossip    ","wordCount":"3503","inLanguage":"en","image":"https://blog.hypertars.com/posts/developer/database/cassandra/https:/upload.wikimedia.org/wikipedia/commons/5/5e/Cassandra_logo.svg","datePublished":"2021-05-08T00:00:00+08:00","dateModified":"2021-05-08T00:00:00+08:00","author":[{"@type":"Person","name":"HyperTars"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hypertars.com/posts/developer/database/cassandra/"},"publisher":{"@type":"Organization","name":"HyperTars' Blog","logo":{"@type":"ImageObject","url":"https://blog.hypertars.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.hypertars.com accesskey=h title="HyperTars' Blog (Alt + H)">HyperTars' Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://hypertars.com title=🏠Home><span>🏠Home</span></a></li><li><a href=https://blog.hypertars.com/search/ title="🔍Search (Alt + /)" accesskey=/><span>🔍Search</span></a></li><li><a href=https://blog.hypertars.com/posts/developer/ title=👨🏻‍💻Developer><span>👨🏻‍💻Developer</span></a></li><li><a href=https://blog.hypertars.com/archives/ title=⏱Archives><span>⏱Archives</span></a></li><li><a href=https://blog.hypertars.com/tags/ title=🔖tags><span>🔖tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.hypertars.com>Home</a>&nbsp;»&nbsp;<a href=https://blog.hypertars.com/posts/>Articles</a>&nbsp;»&nbsp;<a href=https://blog.hypertars.com/posts/developer/>Developer</a>&nbsp;»&nbsp;<a href=https://blog.hypertars.com/posts/developer/database/>Database</a></div><h1 class=post-title>Apache Cassandra</h1><div class=post-description>A NoSQL Database</div><div class=post-meta><span title="2021-05-08 00:00:00 +0800 +0800">2021-05-08</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;HyperTars</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%ad%98%e5%82%a8%e6%96%b9%e5%bc%8f aria-label=存储方式>存储方式</a></li><li><a href=#%e5%ae%9e%e7%8e%b0 aria-label=实现>实现</a></li><li><a href=#%e7%89%b9%e7%82%b9 aria-label=特点>特点</a></li><li><a href=#%e6%95%b0%e6%8d%ae%e6%a8%a1%e5%9e%8b aria-label=数据模型>数据模型</a><ul><li><a href=#keyspace aria-label=Keyspace>Keyspace</a></li><li><a href=#table aria-label=Table>Table</a></li><li><a href=#column aria-label=Column>Column</a></li></ul></li><li><a href=#%e6%9e%b6%e6%9e%84 aria-label=架构>架构</a><ul><li><a href=#%e5%ad%98%e5%82%a8%e7%bb%93%e6%9e%84 aria-label=存储结构>存储结构</a></li><li><a href=#%e7%bc%93%e5%ad%98 aria-label=缓存>缓存</a></li><li><a href=#%e5%a2%93%e7%a2%91 aria-label=墓碑>墓碑</a></li><li><a href=#bloom-filter aria-label="Bloom Filter">Bloom Filter</a></li><li><a href=#%e5%88%86%e5%b8%83%e5%bc%8f%e6%9e%b6%e6%9e%84 aria-label=分布式架构>分布式架构</a></li><li><a href=#gossip aria-label=Gossip>Gossip</a></li><li><a href=#hinted-handoff aria-label="hinted handoff">hinted handoff</a></li><li><a href=#%e4%b8%80%e8%87%b4%e6%80%a7%e7%ad%89%e7%ba%a7 aria-label=一致性等级>一致性等级</a></li><li><a href=#%e5%86%99%e6%93%8d%e4%bd%9c aria-label=写操作>写操作</a></li><li><a href=#%e8%af%bb%e6%93%8d%e4%bd%9c aria-label=读操作>读操作</a></li><li><a href=#%e4%ba%8b%e5%8a%a1 aria-label=事务>事务</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a><ul><li><a href=#%e9%80%82%e7%94%a8%e5%9c%ba%e6%99%af aria-label=适用场景>适用场景</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const e=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=存储方式>存储方式<a hidden class=anchor aria-hidden=true href=#存储方式>#</a></h2><p>宽列存储 / 列簇存储</p><h2 id=实现>实现<a hidden class=anchor aria-hidden=true href=#实现>#</a></h2><p>DynamoDB - 副本复制模型、无单点失效架构
BigTable - 数据和存储引擎模型</p><table><thead><tr><th>Category</th><th>Dynamo</th><th>BigTable</th></tr></thead><tbody><tr><td>Arch</td><td>Decentralized</td><td>Centralized</td></tr><tr><td>Data Model</td><td>Key-Value</td><td>Column-Oriented</td></tr><tr><td>API</td><td>Get, Put</td><td>Get, Put, Scan, Delete</td></tr><tr><td>Security</td><td>No</td><td>Access control at column-family level</td></tr><tr><td>Partitioning</td><td>Consistent Hashing</td><td>Key range based</td></tr><tr><td>Replication</td><td>Across data centers</td><td>No, Within a single data center in GFS</td></tr><tr><td>Storage</td><td>Plug-in</td><td>SSTables in GFS</td></tr><tr><td>Read/Write</td><td>Quorum-like</td><td>Reads - merge of SSTables and memtable, Writes-tablet log and memtable</td></tr><tr><td>Concurrency Control</td><td>Vector clocks with reconciliation during reads</td><td>Copy-On-Write</td></tr><tr><td>Membership and failure detection</td><td>Gossip-based protocol</td><td>Handshakes initiated by master</td></tr><tr><td>CAP</td><td>AP</td><td>CP</td></tr></tbody></table><h2 id=特点>特点<a hidden class=anchor aria-hidden=true href=#特点>#</a></h2><ul><li>完整的多主数据库复制</li><li>高可用, 容错</li><li>弹性可扩展</li><li>分区的面相键查询</li><li>可调节的一致性 AP or CP</li><li>无 Schema</li><li>写性能高</li></ul><h2 id=数据模型>数据模型<a hidden class=anchor aria-hidden=true href=#数据模型>#</a></h2><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Keyspace: <span style=color:#0ff;font-weight:700>${</span>KeyspaceName<span style=color:#0ff;font-weight:700>}</span>
</span></span><span style=display:flex><span>    ColumnFamily: <span style=color:#0ff;font-weight:700>${</span>ColumnFamilyName<span style=color:#0ff;font-weight:700>}</span>
</span></span><span style=display:flex><span>        Key: <span style=color:#0ff;font-weight:700>${</span>Key1, Key2, ...<span style=color:#0ff;font-weight:700>}</span>
</span></span><span style=display:flex><span>        Columns: {Columns}
</span></span><span style=display:flex><span>            <span style=color:#0ff;font-weight:700>${</span>ColumnName<span style=color:#0ff;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#0ff;font-weight:700>${</span>Data<span style=color:#0ff;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=keyspace>Keyspace<a hidden class=anchor aria-hidden=true href=#keyspace>#</a></h3><ul><li>每个 Keyspace 包含一个或多个 Table, 一般一个集群只需要一个 KeySpace</li><li>属性<ul><li>副本因子 Replication Factor 是每行数据会复制到多少个节点上。副本因子的选择决定了要为一致性付出多少代价, 所得到的读写的一致性水平取决于副本因子的设定。</li><li>副本放置策略</li></ul></li></ul><h3 id=table>Table<a hidden class=anchor aria-hidden=true href=#table>#</a></h3><ul><li>与 ColumnFamily 为相同概念, 类似于关系型数据库里的表。是容纳一个有序的行集合的容器。每一行又是有序的列的集合。向 Cassandra 读写数据时, 可以为一列或多列指定值, 至少包含一个主键值。</li></ul><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cassandra&gt; getHotelier.Hotel[<span style=color:#0ff;font-weight:700>&#39;NYN_042&#39;</span>]
</span></span><span style=display:flex><span>=&gt;(column=zip, value=10019, timestamp=3894166157031651)
</span></span><span style=display:flex><span>=&gt;(column=state, value=NY, timestamp=3894166157031651)
</span></span><span style=display:flex><span>=&gt;(column=phone, value=2125555555, timestamp=3894166157031651)
</span></span><span style=display:flex><span>=&gt;(column=name, value=TheWaldorf=Astoria, timestamp=3894166157031651)
</span></span><span style=display:flex><span>=&gt;(column=city, value=NewYork, timestamp=3894166157031651)
</span></span><span style=display:flex><span>=&gt;(column=address, value=301ParkAve, timestamp=3894166157031651)
</span></span><span style=display:flex><span>Returned <span style=color:#ff0;font-weight:700>6</span> results.
</span></span></code></pre></td></tr></table></div></div><h3 id=column>Column<a hidden class=anchor aria-hidden=true href=#column>#</a></h3><ul><li><p>列是由名称、值和时间戳组成的三元组。相当于表中的一个携带时间戳的单元格。Cassandra 之中不需要预先定义列, 只需要在 keyspace 里定义表就可以写数据了, 所有列的名字都是客户端提供的。使 Cassandra 看起来像四维 Hash: <code>[Keyspace][Table][Key][Column]</code></p></li><li><p>特性</p><ul><li>同一表的行在磁盘上存储在一起</li><li>Cassandra 不支持 Join</li><li>同一表中, 列是可以根据列名排序的 (一般是字典序, 用于高效地从很宽的行里高效取出一列而无需把每列都读入内存)</li><li>除了写入时间外, 还额外存储了 TTL (TTL 是 Column 粒度的)</li></ul></li><li><p>二级索引</p><ul><li>Cassandra允许对列建二级索引, 由于Cassandra将数据划分到多个节点上, 每个节点必须根据存储在相应分区上的数据维护自己的二级索引, 因此二级索引的查询通常涉及多个节点, 导致查询开销显著增加。通常为读性能考虑更倾向于物化视图 (写开销大)。</li></ul></li></ul><h2 id=架构>架构<a hidden class=anchor aria-hidden=true href=#架构>#</a></h2><h3 id=存储结构>存储结构<a hidden class=anchor aria-hidden=true href=#存储结构>#</a></h3><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Write
</span></span><span style=display:flex><span>    -&gt; CommitLog
</span></span><span style=display:flex><span>        -&gt; Memtable
</span></span><span style=display:flex><span>            -&gt; SSTable
</span></span><span style=display:flex><span>            -&gt; SSTable
</span></span><span style=display:flex><span>            -&gt; SSTable
</span></span><span style=display:flex><span>            -&gt; ...
</span></span></code></pre></td></tr></table></div></div><ul><li>CommitLog - Memtable - SSTable<ul><li>进行写操作的时候, 数据是直接写入到 commitlog 中的。写操作只有写入到 commitlog 才被认为是成功的, 这样, 即使数据还没有进入内存 memtable 中, 也可以进行数据恢复。</li><li>数据写入到 commitlog 中之后, 同时写入内存中名为 memtable 的数据结构之中。当memtable 之中存储的对象数量达到阈值(或者容量达到阈值, 或者达到某时间间隔)之后, memtable 会被刷入磁盘 SSTable 文件中。然后, 创建一个新的 memtable, 接收数据。这个过程是个非阻塞操作, 对于一个表, 可以有多个 memtable, 一个是当前的, 其他的则是等待写入磁盘的。这个过程通常不会很长, 除非节点过载了, 否则刷写的过程应该会很快。</li><li>SSTable 的概念是从 Google 的 Bigtable 里借鉴过来的。一旦 memtable 被刷写入磁盘, 成为一个 SSTable, 它就是不可变的了。SSTable 可以合并, 合并是进行了归并排序的“归并”步骤, 将数据并入新的文件, 并删除旧文件。</li><li>所有的写操作是顺序进行的, <strong>这是 Cassandra 的写操作性能出众的主要原因。在 Cassandra 之中, 所有的写都是 append 操作, 没有任何读或查找操作</strong>。合并操作定期地重新组织数据, 不过合并操作同样也是进行顺序读写。合并操作可以获得更好的读性能。</li></ul></li></ul><img src=https://upload.wikimedia.org/wikipedia/commons/f/f2/LSM_Tree.png width=500 align=center><h3 id=缓存>缓存<a hidden class=anchor aria-hidden=true href=#缓存>#</a></h3><ul><li>Key 缓存: Key -> 行索引的映射 (Key1 - DataPosition1, Key2 - DataPosition2), 存在 JVM 堆上, 默认打开</li><li>行缓存: 缓存所有的行, 存在堆外内存, 默认禁用</li></ul><h3 id=墓碑>墓碑<a hidden class=anchor aria-hidden=true href=#墓碑>#</a></h3><ul><li>所有的删除操作都转化为更新操作, 在值上放置墓碑, 在合并阶段才真正删除</li></ul><h3 id=bloom-filter>Bloom Filter<a hidden class=anchor aria-hidden=true href=#bloom-filter>#</a></h3><img src=https://upload.wikimedia.org/wikipedia/commons/c/c4/Bloom_filter_speed.svg width=600 align=center><h3 id=分布式架构>分布式架构<a hidden class=anchor aria-hidden=true href=#分布式架构>#</a></h3><ul><li>单个 Data Center 使用一致性哈希环的架构</li><li>通过 <a href=https://github.com/spaolacci/murmur3>murmur3</a> 算法给 Key 计算 64 位 Hash 值, 去落到不同的节点上。Cassandra 默认支持虚拟节点, 为每个节点分配 256 个令牌。</li><li>副本默认策略是放置在环中接下来的 N 个节点中</li></ul><img src=https://upload.wikimedia.org/wikipedia/commons/c/cb/Token_ring.svg width=500 align=center><h3 id=gossip>Gossip<a hidden class=anchor aria-hidden=true href=#gossip>#</a></h3><ul><li>为了做到无中心、容忍网络分裂, Cassandra 使用了一个 gossip 协议来进行环内通信, 这样每个节点都会有其他节点的状态信息。</li><li>Gossiper 在定时器的控制下, 每秒钟运行一次。提示移交 (hinted-handoff) 是由 gossip 触发的。当一个节点发现另一个节点重新在线, 而它正好有关于这个节点的提示信息时, 就会触发提示移交。</li><li>Gosspier 周期性的运行, 在环里随机选择一个节点, 发起对这个节点的 gossip 回话。每轮 gossip 需要三条消息。不仅交换自身信息, 还交换通过之前的 gossip 通信了解的其他节点信息。所以所有的节点能够很快的了解集群中的其他节点情况。<ol><li>Gossip 的发起者给它选好的伙伴节点发送一条 GossipDigestSyncMessage</li><li>当伙伴节点收到消息时, 回复一条 GossipDigestAckMessage</li><li>发起者收到伙伴发回的响应消息后, 再向伙伴发送一条 GossipDigestAck2Message, 以此完成本轮 gossip</li></ol></li><li>相比于一个固定的阈值来标记一个节点为 fail, Cassandra 采用一个自然增长的检测机制来计算每个节点的阈值, 考虑到了网络、负载、历史状况等因素。当进行 gossip 交换时, 每个节点维护了一个其他节点 gossip 信息到达滑动窗口时间。可以通过配置 <code>phi_convict_threshold</code> 属性来调节失败检测的敏感性。</li></ul><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>class</span> GossipDigest <span style=color:#fff;font-weight:700>implements</span> Comparable&lt;GossipDigest&gt; {
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>final</span> InetAddressAndPort endpoint;
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>final</span> <span style=color:#fff;font-weight:700>int</span> generation; <span style=color:#007f7f>// generation stays the same when server is running and grows every time the node is started 
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>    <span style=color:#fff;font-weight:700>final</span> <span style=color:#fff;font-weight:700>int</span> maxVersion;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>class</span> GossipDigestSyn {
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>final</span> String clusterId;
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>final</span> String partioner;
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>final</span> List&lt;GossipDigest&gt; gDigests; 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>class</span> GossipDigestAck {    
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>final</span> List&lt;GossipDigest&gt; gDigestList;
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>final</span> Map&lt;InetAddressAndPort, EndpointState&gt; epStateMap;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>class</span> GossipDigestAck2 {
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>final</span> Map&lt;InetAddressAndPort, EndpointState&gt; epStateMap;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=hinted-handoff>hinted handoff<a hidden class=anchor aria-hidden=true href=#hinted-handoff>#</a></h3><ul><li>一个写请求到达 Cassandra，但是负责这部分数据的节点却由于网络分裂、硬件故障或其他原因而不可用。为了保证整个环在这种情况下的可用性，Cassandra 实现了一个称为提示移交（hintedhandoff）的机制。</li><li>可以把一个提示看做是一个小即时贴，上面记录着写请求的内容。如果写操作所属的节点失败了，Cassandra 接收到该请求的节点会创建一个提示，包含这样一条备忘信息：“我有一个给节点B的写请求信息。这个请求现在挂起了，等到节点B回来的时候请告知我，那时我会把写请求送交给它。”也就是说，写操作的提示信息将会从节点A移交给节点B。</li></ul><h3 id=一致性等级>一致性等级<a hidden class=anchor aria-hidden=true href=#一致性等级>#</a></h3><ul><li><p>因为Cassandra中的读写操作可以分别指定一致性级别，所以Cassandra的一致性被认为是可调的。</p></li><li><p>ZERO (deprecated): 在写数据被记录之前就返回；写操作将会在一个后台线程中异步完成，无法确保写操作一定成功</p></li><li><p>ANY: 集群中任意一台服务器响应（包括HINT）即成功</p></li><li><p>ONE, TWO, THREE: 集群中任意1/2/3台服务器响应（不包括HINT，即写commitlog成功）即成功</p></li><li><p><strong>QUORUM (Most Freq)</strong>: 集群中响应（不包括HINT）的服务器数量>=ReplicationFactor/2+1即成功。平衡一致性和高可用性的方案。</p></li><li><p>LOCAL_QUORUM: 在QUORUM基础上，要求写入成功的节点至少有一台与接受写入操作的服务器属同一DC</p></li><li><p>EACH_QUORUM: 在QUORUM基础上，要求写入成功的节点至少有一台与接受写入操作的服务器不属同一DC</p></li><li><p>ALL: 集群中响应写入成功的服务器数量等于 ReplicationFactor 即成功</p></li><li><p>不论是读操作还是写操作, ZERO, ANY, ONE 都被划分为弱一致性, 而 QUORUM 和 ALL 则属于强一致性。在 Cassandra 中, 要达到强一致性, 可以使用如下这个流行的公式: <code>R + W > N => Strong Consistency</code>。R: Read Replica, W: Write Replica, N: Replication Factor。这时, 所有客户端都可以得到最新的写入结果, 即可以得到强一致性。</p></li></ul><h3 id=写操作>写操作<a hidden class=anchor aria-hidden=true href=#写操作>#</a></h3><ul><li>如果集群跨多个 DC, 本地协调器节点会在其他各个数据中心分别选择一个远程协调器, 每个远程副本直接响应原协调器节点。</li><li>一旦有满足一致性级别要求的副本作出响应, 则协调器向客户端确认这个写操作。</li></ul><h3 id=读操作>读操作<a hidden class=anchor aria-hidden=true href=#读操作>#</a></h3><ul><li>协调器会把请求发给认为最近的 (snich 策略) 一个副本读完整数据本地计算摘要, 从其他副本直接请求摘要, 如果一致且满足一致性要求, 则返回数据。如果摘要不一致, 协调器回完成修复。</li></ul><h3 id=事务>事务<a hidden class=anchor aria-hidden=true href=#事务>#</a></h3><ul><li>Cassandra 支持轻量级事务, 基于 <code>Paxos</code> 共识算法实现<ul><li>基本 Paxos 算法包含两个阶段:<ol><li>准备 / 承诺</li><li>提议 / 接受。</li></ol></li><li>要修改数据, 会有一个协调器节点担任领导者的角色, 向其他副本节点提出一个新值。其他节点同时担任其他修改的领导者。每个副本节点会检查提议, 如果这个提议看到的是最新提议, 它会承诺不接受之前任何提议关联的提议。每个副本节点会返回它接受的最新提议。如果这个提议被大多数副本接受, 领导者就会提交这个提议, 但需要注意的是, 必须先提交这个提议之前的所有在处理的提议。</li><li>Cassandra 实现扩展了基本 Paxos 算法来支持所需的 <code>写前读</code> 语义, 也称为 <code>检查-设置</code>, 并允许在事务之间重置状态。为此, 它在算法中插入了额外的两个阶段, 现在的工作如下:<ol><li>准备 / 承诺</li><li>读 / 结果</li><li>提议 / 接受</li><li>提交 / 确认</li></ol></li><li>Cassandra 会为每个分区存储一个 Paxos 状态, 可以保证不同分区的事务不会互相打扰。</li></ul></li></ul><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><h3 id=适用场景>适用场景<a hidden class=anchor aria-hidden=true href=#适用场景>#</a></h3><ol><li>大规模部署: 分布式架构</li><li>写密集、统计和分析型: 有高可用性, 有写吞吐量优化</li><li>多数据中心结构: 有针对多 DC 设计和相关配置</li></ol><table><thead><tr><th>Category</th><th>Cassandra</th></tr></thead><tbody><tr><td>CAP</td><td>AP or CP</td></tr><tr><td>通信</td><td>Gossip</td></tr><tr><td>oltp/olap</td><td>偏重oltp</td></tr><tr><td>API</td><td>支持SQL语法(通过二级索引)</td></tr><tr><td>路由</td><td>Snitch算法</td></tr><tr><td>语言</td><td>Java</td></tr><tr><td>设计参考</td><td>BigTable and Dynamo</td></tr><tr><td>License</td><td>Apache</td></tr><tr><td>Protocol</td><td>CQL, binary (Thrift)</td></tr><tr><td>数据分布</td><td>水平扩展：改进的一致性哈希（虚拟节点）</td></tr><tr><td>存储目标</td><td>小文件</td></tr><tr><td>一致性</td><td>可选，一般选最终一致性，Quorum策略</td></tr><tr><td>架构</td><td>p2p</td></tr><tr><td>高可用性</td><td>P2P和去中心化设计，不会出现单点故障</td></tr><tr><td>伸缩性</td><td>扩容需在Hash Ring上多个节点间调整数据分布</td></tr><tr><td>读写性能</td><td>数据读写定位非常快</td></tr><tr><td>数据冲突处理</td><td>向量时钟</td></tr><tr><td>临时故障处理</td><td>数据回传机制：某节点宕机，hash到该节点的新数据自动路由到下一节点做 hinted handoff，源节点恢复后，推送回源节点。</td></tr><tr><td>永久故障恢复</td><td>Merkle 哈希树，通过Gossip协议同步Merkle Tree，维护集群节点间的数据一致性</td></tr><tr><td>成员通信及错误检测</td><td>基于Gossip</td></tr></tbody></table></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.hypertars.com/tags/database/>Database</a></li><li><a href=https://blog.hypertars.com/tags/nosql/>NoSQL</a></li></ul><nav class=paginav><a class=prev href=https://blog.hypertars.com/posts/developer/database/clickhouse/><span class=title>« Prev Page</span><br><span>ClickHouse</span></a>
<a class=next href=https://blog.hypertars.com/posts/developer/distributed_systems/cache/><span class=title>Next Page »</span><br><span>分布式缓存一致性问题</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Apache Cassandra on twitter" href="https://twitter.com/intent/tweet/?text=Apache%20Cassandra&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdatabase%2fcassandra%2f&hashtags=Database%2cNoSQL"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Cassandra on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdatabase%2fcassandra%2f&title=Apache%20Cassandra&summary=Apache%20Cassandra&source=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdatabase%2fcassandra%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Cassandra on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdatabase%2fcassandra%2f&title=Apache%20Cassandra"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Cassandra on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdatabase%2fcassandra%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Cassandra on whatsapp" href="https://api.whatsapp.com/send?text=Apache%20Cassandra%20-%20https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdatabase%2fcassandra%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Apache Cassandra on telegram" href="https://telegram.me/share/url?text=Apache%20Cassandra&url=https%3a%2f%2fblog.hypertars.com%2fposts%2fdeveloper%2fdatabase%2fcassandra%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>